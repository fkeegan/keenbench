# KeenBench — Functional Test Plan

## Policy

**Every test that involves AI interaction MUST use real model API calls. No exceptions.**
No fake/mock AI clients. No `KEENBENCH_FAKE_OPENAI`. No conditional branching on fake vs real mode.
Assertions on AI output must be structural or numerical — never exact-text-match on prose.
See `CLAUDE.md` for the full testing policy.

## Scope

This test plan covers all milestones (M0 through M3):
- Settings: provider key management, multi-provider, model selection
- Workbench: create/open/delete, file add/remove, limits, semantics
- Workbench context: persistent company/department/situation/style context items
- Workshop: streaming chat, conversation persistence, agentic tool-use loop
- Egress consent: per-workbench, per-scope, per-provider/model
- Draft: auto-propose, auto-apply, review, publish, discard
- Review: offline diffs, side-by-side previews, text extraction diffs
- Office files: DOCX, XLSX, PPTX read/write via tool worker
- PDF, ODT, images: read-only ingest with previews
- Multi-provider: OpenAI, Anthropic, Gemini
- Checkpoints: create, list, restore
- Clutter bar: context usage signal
- Safety: sandbox enforcement, egress allowlist, draft gating, error codes

## Test Environment

- Linux desktop (X11). E2E harness targets `flutter test integration_test -d linux`.
- Network access to: `api.openai.com`, `api.anthropic.com`, `generativelanguage.googleapis.com`.
- Valid API keys in `.env`:
  - `KEENBENCH_OPENAI_API_KEY` (required for all AI tests)
  - `KEENBENCH_ANTHROPIC_API_KEY` (required for multi-provider tests)
  - `KEENBENCH_GEMINI_API_KEY` (required for multi-provider tests)
- Clean app data directory per test run (`KEENBENCH_DATA_DIR` pointed to temp dir).
- Python venv with tool worker dependencies (`engine/tools/pyworker/.venv`).

## Test Data

### Bundled fixtures (in repo)

| File | Location | Description |
|------|----------|-------------|
| `notes.txt` | `app/integration_test/support/` | Staffing meeting notes (projects Atlas/Beacon, 5 employees, decisions, open items) |
| `data.csv` | `app/integration_test/support/` | Employee roster CSV (name, role, location, availability) with 5 rows |
| `simple.docx` | `engine/testdata/office/` | Simple Word document with paragraphs and headings |
| `multi-sheet.xlsx` | `engine/testdata/office/` | Excel workbook with multiple sheets |
| `slides.pptx` | `engine/testdata/office/` | PowerPoint with 2-3 slides |
| `report.pdf` | `engine/testdata/office/` | PDF report (read-only) |
| `notes.odt` | `engine/testdata/office/` | OpenDocument text (read-only) |
| `chart.png` | `engine/testdata/office/` | PNG image (read-only) |
| `logo.svg` | `engine/testdata/office/` | SVG image (read-only) |
| `unknown.bin` | `engine/testdata/office/` | Unknown binary format (opaque) |

### Real-world data (user-provided)

| File | Location | Description |
|------|----------|-------------|
| `cuentas_octubre_2024_anonymized_draft.xlsx` | `engine/testdata/real/` | Anonymized Santander bank statement. Sheet "Movimientos", 103 transactions (rows 9-111), columns: FECHA OPERACIÓN, FECHA VALOR, CONCEPTO, IMPORTE EUR, SALDO. All expenses, total -12,257.08. Running balance from 31,793.85 (row 10) down to 10,856.40 (last row). 100 unique CONCEPTO values. Transaction types: Pago Movil, Compra Comercio, Compra Internet, Recibo, Transferencia, etc. |

### Synthetic data (`engine/testdata/synthetic/`, generated by `scripts/testdata/generate_fixtures.py`)

| File | Purpose | Specification |
|------|---------|--------------|
| `big.csv` | Oversize rejection test | >25 MB, repeated rows |
| `world_gdp.csv` | Public tabular data test | World Bank GDP data — 5 columns: Country, Year, GDP_USD, Population, GDP_Per_Capita. 50 countries, 10 years (2014-2023). ~500 rows. Source: World Bank Open Data or synthetic equivalent. |
| `projects.csv` | Multi-file merge test | CSV with columns: Project, Start Date, Status. 2 rows (Atlas, Beacon). |
| `budget_notes.txt` | Budget cross-reference | Text: "Monthly budget: Entertainment 500 EUR, Groceries 800 EUR, Transport 200 EUR, Bills 2000 EUR." |
| `client_data.csv` | Template fill data source | CSV with one row: Acme Corp, 2026-03-01, Widget, 50, 24.99. |
| `invoice_template.docx` | DOCX template fill test | Word document with placeholder fields: {{company}}, {{date}}, {{items_table}}, {{total}}. Heading + table structure. |
| `quarterly_data.xlsx` | Multi-sheet analysis test | 4 sheets (Q1-Q4), each with columns: Date, Category, Amount, Description. 12 rows per sheet. Known totals: Q1=4460.99, Q2=5052.99, Q3=4484.99, Q4=5963.00, Grand=19961.97. |
| `project_update.pptx` | Presentation editing test | 5 slides: title, overview (bullet points), data table, chart description, conclusion. |

### Public data sources for additional permutations

- **World Bank Open Data** (`data.worldbank.org`): GDP, population, education indicators. CSV download, well-structured.
- **NYC Open Data** (`data.cityofnewyork.us`): 311 complaints, restaurant inspections. Messy real-world data.
- **Project Gutenberg** (`gutenberg.org`): Plain text literary works for text extraction/formatting tests.
- **EU Open Data** (`data.europa.eu`): Multilingual datasets for encoding edge cases.

## Conventions

- **Priority:** P0 = must-pass, P1 = important, P2 = nice-to-have.
- **IDs:** `TC-###`. No milestone prefix — test cases apply across milestones.
- **AI tests:** Marked with `[AI]` tag. These MUST use real model calls.
- **Steps format:** Each step is an atomic action followed by `Expected:` with the verifiable result.
- **Timeout convention:** AI-driven steps use 60-120s timeouts unless noted.

---

## Test Cases

### 1. Setup and Smoke

#### TC-001: Launch app and engine handshake
- Priority: P0
- Preconditions: Fresh app data dir. Engine binary built.
- Steps:
  1. Launch the app via `make run` or `flutter run -d linux`.
     Expected: The home screen appears (`AppKeys.homeScreen` is visible). No error dialogs or crash logs.
  2. Verify the home screen shows "Create a Workbench to begin." (`AppKeys.homeEmptyState`).
     Expected: The empty state message is displayed. The workbench grid (`AppKeys.homeWorkbenchGrid`) is empty.
  3. Verify the Settings button (`AppKeys.homeSettingsButton`) is visible and enabled.
     Expected: The settings icon button is rendered in the app bar.

#### TC-002: Open Settings and view initial provider status
- Priority: P0
- Preconditions: App launched, home screen visible.
- Steps:
  1. Click the Settings button (`AppKeys.homeSettingsButton`).
     Expected: The Settings screen (`AppKeys.settingsScreen`) opens with title "Settings".
  2. Locate the OpenAI provider card.
     Expected: The card displays "OpenAI" as the provider name.
  3. Read the provider status text (`AppKeys.settingsProviderStatus`).
     Expected: The status reads "Not configured" (displayed in orange/warning color).
  4. Verify the API key field (`AppKeys.settingsApiKeyField`) is empty.
     Expected: The text field shows the placeholder "Keys are stored locally and encrypted at rest" with no value.

---

### 2. Settings and Provider Key

#### TC-003: Save invalid OpenAI key
- Priority: P0
- Preconditions: Settings screen open. No key previously configured.
- Steps:
  1. Click on the API key field (`AppKeys.settingsApiKeyField`).
     Expected: The text field gains focus and shows a cursor.
  2. Type `sk-invalid-test-key-12345` into the field.
     Expected: The text appears in the field as typed (obscured).
  3. Click the "Save & Validate" button (`AppKeys.settingsSaveButton`).
     Expected: A loading indicator appears on the button. After 2-10 seconds, a SnackBar appears with an error message containing "invalid" or "auth" or "failed".
  4. Read the provider status text (`AppKeys.settingsProviderStatus`).
     Expected: The status still reads "Not configured".

#### TC-004: Save valid OpenAI key
- Priority: P0
- Preconditions: Settings screen open. Valid `KEENBENCH_OPENAI_API_KEY` available in `.env`.
- Steps:
  1. Clear the API key field (`AppKeys.settingsApiKeyField`) and type the valid key from `KEENBENCH_OPENAI_API_KEY`.
     Expected: The key text appears in the field (obscured).
  2. Click "Save & Validate" (`AppKeys.settingsSaveButton`).
     Expected: A loading indicator appears. After 2-15 seconds, a SnackBar appears with text "Key saved and validated." or "OpenAI key saved."
  3. Read the provider status text (`AppKeys.settingsProviderStatus`).
     Expected: The status reads "Configured" (displayed in green/success color).
  4. Verify the provider toggle (`AppKeys.settingsProviderToggle`) is in the ON position.
     Expected: The switch widget is toggled ON.

#### TC-005: Provider enable/disable gating
- Priority: P1
- Preconditions: Valid OpenAI key configured. A workbench exists with at least one file.
- Steps:
  1. From the workbench screen, click the Settings button (`AppKeys.workbenchSettingsButton`) in the bottom-left of the sidebar.
     Expected: The Settings screen (`AppKeys.settingsScreen`) opens.
  2. Locate the OpenAI provider toggle (`AppKeys.settingsProviderToggle`) and click it to switch it OFF.
     Expected: The toggle animates to the OFF position. The provider status may update.
  3. Click the back button to return to the workbench screen.
     Expected: The workbench screen (`AppKeys.workbenchScreen`) is displayed with the file list and composer visible.
  4. Click the composer field (`AppKeys.workbenchComposerField`) and type "Hello".
     Expected: The text "Hello" appears in the composer field.
  5. Click the Send button (`AppKeys.workbenchSendButton`).
     Expected: A dialog appears (`AppKeys.providerRequiredDialog`) with title containing "key required" and text indicating the provider needs to be configured. The dialog has an "Open Settings" button (`AppKeys.providerRequiredOpenSettings`).
  6. Click "Cancel" (`AppKeys.providerRequiredCancel`) to dismiss the dialog.
     Expected: The dialog closes. The composer still contains "Hello". No assistant message was generated.
  7. Click the Settings button, re-enable the OpenAI toggle, and return to the workbench.
     Expected: The provider is re-enabled. The workbench screen is displayed.
  8. Click Send again (the composer should still have "Hello" or re-type it).
     Expected: The consent dialog appears (if first message) or the message sends and an assistant response begins streaming.

#### TC-006: Key persistence across restart
- Priority: P0
- Preconditions: Valid OpenAI key saved and validated.
- Steps:
  1. Note the current provider status ("Configured").
     Expected: Status is "Configured".
  2. Quit the app completely (close the window or terminate the process).
     Expected: The app window closes.
  3. Relaunch the app.
     Expected: The home screen appears.
  4. Click Settings (`AppKeys.homeSettingsButton`).
     Expected: The Settings screen opens.
  5. Read the provider status text (`AppKeys.settingsProviderStatus`).
     Expected: The status reads "Configured". The key was persisted (encrypted at rest) and does not need re-entry.

---

### 3. Workbench Creation and File Management

#### TC-007: Create a new Workbench
- Priority: P0
- Preconditions: App on home screen.
- Steps:
  1. Click "New Workbench" (`AppKeys.homeNewWorkbenchButton`).
     Expected: A dialog appears (`AppKeys.newWorkbenchDialog`) with a text field (`AppKeys.newWorkbenchNameField`) and "Create" / "Cancel" buttons.
  2. Type "Financial Analysis" into the name field.
     Expected: The text "Financial Analysis" appears in the field.
  3. Click "Create" (`AppKeys.newWorkbenchCreateButton`).
     Expected: The dialog closes. The workbench screen (`AppKeys.workbenchScreen`) opens with title "Financial Analysis". The file list (`AppKeys.workbenchFileList`) is empty. The scope description text is visible (`AppKeys.workbenchScopeLimits`).
  4. Verify the composer field (`AppKeys.workbenchComposerField`) is visible with placeholder "Ask the Workshop...".
     Expected: The composer is present and enabled.

#### TC-008: Add text and CSV files
- Priority: P0
- Preconditions: Workbench "Financial Analysis" open, no Draft, no files.
- Steps:
  1. Programmatically add `notes.txt` and `data.csv` via the engine API `WorkbenchFilesAdd` (or click "Add files" and select them).
     Expected: Both files appear in the file list. `notes.txt` shows a file row (`AppKeys.workbenchFileRow('notes.txt')`) with a "TXT" badge. `data.csv` shows a row with a "CSV" badge.
  2. Verify both file rows have an extract button (`AppKeys.workbenchFileExtractButton('notes.txt')`) and a remove button (`AppKeys.workbenchFileRemoveButton('notes.txt')`).
     Expected: Both action buttons are visible and enabled (no draft exists).
  3. Verify the scope badge (`AppKeys.workbenchScopeBadge`) shows "Scoped" or the scope limits text updates to reflect the file count.
     Expected: The file count in the scope area reflects 2 files.

#### TC-009: Add office files (DOCX, XLSX, PPTX, PDF, images)
- Priority: P0
- Preconditions: Workbench open, no Draft.
- Steps:
  1. Add `simple.docx`, `multi-sheet.xlsx`, `slides.pptx`, `report.pdf`, `chart.png`, `logo.svg` via `WorkbenchFilesAdd`.
     Expected: All 6 files appear in the file list with appropriate badges: "DOCX", "XLSX", "PPTX", "PDF", "PNG", "SVG".
  2. Verify `report.pdf`, `chart.png`, `logo.svg` show a "Read-only" badge on their file rows.
     Expected: Read-only files are visually distinguished.
  3. Verify the file count in scope limits reflects the correct total.
     Expected: File count shows the correct number (2 previous + 6 = 8, or per the test setup).

#### TC-010: Add opaque file
- Priority: P1
- Preconditions: Workbench open, no Draft.
- Steps:
  1. Add `unknown.bin` via `WorkbenchFilesAdd`.
     Expected: The file appears in the list with an "Opaque" badge. No error occurs.
  2. Verify the opaque flag is set on the file by checking `WorkbenchState.files`.
     Expected: The file's `isOpaque` property is `true`.

#### TC-011: File count limit (batch reject at 10)
- Priority: P0
- Preconditions: Workbench has 9 files already.
- Steps:
  1. Create two new temp files: `extra1.txt` and `extra2.txt`.
     Expected: Files exist on disk.
  2. Attempt to add both files via `WorkbenchFilesAdd` in a single call.
     Expected: The add operation fails with an error. The error message references the file count limit (10). No new files are added to the workbench. The file list still shows 9 files.

#### TC-012: Oversize file skip (>25 MB)
- Priority: P0
- Preconditions: Workbench open, no Draft, fewer than 10 files.
- Steps:
  1. Create `big.csv` (>25 MB, e.g., a repeated row to exceed the limit) and a small `small.txt` (a few bytes).
     Expected: Both files exist on disk.
  2. Attempt to add both `big.csv` and `small.txt` in a single `WorkbenchFilesAdd` call.
     Expected: `small.txt` is added successfully (appears in file list). `big.csv` is skipped. The add result includes a skip reason mentioning the size limit (25 MB). The file list does NOT contain `big.csv`.

#### TC-013: Duplicate filename rejection
- Priority: P0
- Preconditions: Workbench has `notes.txt` already added.
- Steps:
  1. Create a different file at a different path but also named `notes.txt` (e.g., `/tmp/test/notes.txt`).
     Expected: File exists on disk with different content than the workbench copy.
  2. Attempt to add this `notes.txt` via `WorkbenchFilesAdd`.
     Expected: The entire add batch is rejected with a duplicate-name error. No new files are added.

#### TC-014: Symlink rejection
- Priority: P1
- Preconditions: Workbench open, `notes.txt` exists on disk.
- Steps:
  1. Create a symlink `link_to_notes` pointing to `notes.txt`.
     Expected: Symlink exists.
  2. Attempt to add `link_to_notes` via `WorkbenchFilesAdd`.
     Expected: The add fails with an error mentioning "links not supported" or "symlink". No file is added.

#### TC-015: Remove file from workbench
- Priority: P0
- Preconditions: Workbench has `notes.txt` and `data.csv`, no Draft.
- Steps:
  1. Click the remove button (`AppKeys.workbenchFileRemoveButton('notes.txt')`).
     Expected: A confirmation dialog appears (`AppKeys.workbenchRemoveFileDialog`) with text 'Remove "notes.txt" from this Workbench? Originals remain untouched.'
  2. Click "Cancel" (`AppKeys.workbenchRemoveFileCancel`).
     Expected: The dialog closes. `notes.txt` is still in the file list.
  3. Click the remove button again.
     Expected: The confirmation dialog reappears.
  4. Click the red confirm button (`AppKeys.workbenchRemoveFileConfirm`).
     Expected: The dialog closes. `notes.txt` is removed from the file list. `data.csv` remains.

#### TC-016: Add/remove blocked while Draft exists
- Priority: P0
- Preconditions: Workbench has files, Draft exists.
- Steps:
  1. Verify the "Add files" button (`AppKeys.workbenchAddFilesButton`) is disabled.
     Expected: The button is grayed out or visually disabled. A tooltip says "Publish or discard the Draft" or similar.
  2. Verify the remove buttons on each file row are disabled.
     Expected: Each file's remove button (`AppKeys.workbenchFileRemoveButton(path)`) is disabled with a tooltip.
  3. Verify the extract buttons on each file row are disabled.
     Expected: Each file's extract button (`AppKeys.workbenchFileExtractButton(path)`) is disabled with a tooltip.

#### TC-017: Delete workbench from home screen
- Priority: P1
- Preconditions: Home screen with at least one workbench tile.
- Steps:
  1. Click the three-dot menu (`AppKeys.workbenchTileMenu(workbenchId)`) on a workbench tile.
     Expected: A popup menu appears with a "Delete Workbench" option.
  2. Click "Delete Workbench" (`AppKeys.workbenchTileDelete(workbenchId)`).
     Expected: A confirmation dialog appears (`AppKeys.homeDeleteWorkbenchDialog`) asking to confirm deletion.
  3. Click "Cancel" (`AppKeys.homeDeleteWorkbenchCancel`).
     Expected: The dialog closes. The workbench tile is still visible.
  4. Repeat steps 1-2, then click the red confirm button (`AppKeys.homeDeleteWorkbenchConfirm`).
     Expected: The dialog closes. The workbench tile is removed from the grid.

---

### 4. Egress Consent

#### TC-020: Consent prompt on first model call `[AI]`
- Priority: P0
- Preconditions: Valid OpenAI key configured. Workbench has `notes.txt` and `data.csv`. No prior consent.
- Steps:
  1. Click the composer field (`AppKeys.workbenchComposerField`) and type "Summarize the files."
     Expected: The text appears in the composer.
  2. Click Send (`AppKeys.workbenchSendButton`).
     Expected: The consent dialog appears (`AppKeys.consentDialog`) with title "Consent required".
  3. Verify the dialog shows the provider name ("OpenAI") and model name in the description text.
     Expected: The text reads "KeenBench will send Workbench content to OpenAI (gpt-4o-mini) to generate responses." (model name may vary).
  4. Verify the file list (`AppKeys.consentFileList`) shows both files with sizes.
     Expected: Two entries: "notes.txt (N bytes)" and "data.csv (N bytes)" where N reflects actual file sizes.
  5. Verify the scope hash (`AppKeys.consentScopeHash`) is displayed.
     Expected: Text reads "Scope hash: <hex string>".

#### TC-021: Cancel consent blocks model call `[AI]`
- Priority: P0
- Preconditions: Consent dialog is visible (from TC-020 step 2).
- Steps:
  1. Click "Cancel" (`AppKeys.consentCancelButton`).
     Expected: The dialog closes. No assistant message appears in the message list. The composer field is still visible and enabled.
  2. Verify the message list has no assistant messages.
     Expected: The message list (`AppKeys.workbenchMessageList`) does not contain any assistant-role messages.

#### TC-022: Grant consent and receive response `[AI]`
- Priority: P0
- Preconditions: Workbench with files, no prior consent.
- Steps:
  1. Type "Summarize the staffing decisions from the roster and notes." in the composer and click Send.
     Expected: The consent dialog appears.
  2. Click "Continue" (`AppKeys.consentContinueButton`).
     Expected: The dialog closes. The user message appears in the message list. After 5-30 seconds, an assistant message begins streaming (text appearing incrementally).
  3. Wait for the assistant response to complete (streaming stops, send button re-enables).
     Expected: The assistant message is complete. It contains text (not empty). The message references staffing, employees, or project-related content (structural assertion: the response is contextually relevant to the files provided). Timeout: 60 seconds.

#### TC-023: Consent persists for same scope `[AI]`
- Priority: P1
- Preconditions: Consent was granted in TC-022.
- Steps:
  1. Type "List any open roles or gaps." in the composer and click Send.
     Expected: NO consent dialog appears. The message sends immediately. An assistant response streams back. Timeout: 60 seconds.
  2. Verify there are now at least 2 assistant messages in the conversation.
     Expected: The message list contains the responses from both TC-022 and this test.

#### TC-024: Consent invalidates on scope change `[AI]`
- Priority: P0
- Preconditions: Consent previously granted for 2 files.
- Steps:
  1. Add a new file `scope_change.txt` (a small text file) to the workbench via `WorkbenchFilesAdd`.
     Expected: The file appears in the file list. File count is now 3.
  2. Type "What changed?" in the composer and click Send.
     Expected: The consent dialog (`AppKeys.consentDialog`) reappears. The file list now shows 3 files including `scope_change.txt`.
  3. Click "Continue" to re-grant consent.
     Expected: The dialog closes. The message sends. An assistant response arrives. Timeout: 60 seconds.

#### TC-025: Consent required when switching provider/model `[AI]`
- Priority: P1
- Preconditions: Consent granted for OpenAI. Anthropic key also configured. Workbench has files.
- Steps:
  1. Change the active model to an Anthropic model via the model selector dropdown in the workbench app bar.
     Expected: The model selector updates to show the Anthropic model name.
  2. Type "Describe the files." in the composer and click Send.
     Expected: The consent dialog reappears showing "Anthropic" as the provider name and the new model name. The file list and scope hash are displayed.
  3. Click "Continue".
     Expected: The message sends. The assistant response arrives from the Anthropic model. Timeout: 90 seconds.

---

### 5. Workshop Chat

#### TC-030: Streaming assistant response with text files `[AI]`
- Priority: P0
- Preconditions: Consent granted. Workbench has `notes.txt` (staffing notes) and `data.csv` (employee roster).
- Steps:
  1. Type "Who is assigned to Project Atlas? List their names and roles." in the composer and click Send.
     Expected: The user message bubble appears in the message list.
  2. Wait for the assistant response to stream.
     Expected: Text appears incrementally in the assistant message area. The response completes within 60 seconds.
  3. Read the completed assistant message.
     Expected: The response contains at least 2 of the following names from the roster: Alice Kim, Chloe Nguyen, Diego Patel. The response mentions roles or project assignments. The response is not empty.

#### TC-031: Streaming assistant response with bank statement XLSX `[AI]`
- Priority: P0
- Preconditions: Consent granted. Workbench has `cuentas_octubre_2024_anonymized_draft.xlsx`.
- Steps:
  1. Type "How many transactions are in this bank statement? What is the total of all IMPORTE EUR values?" in the composer and click Send.
     Expected: The user message appears. The assistant begins reading the file via tool calls.
  2. Wait for the assistant response to complete.
     Expected: The response completes within 120 seconds.
  3. Read the completed assistant message.
     Expected: The response mentions a transaction count in the range of 95-115 (the actual count is 103; AI may count differently depending on which rows it considers headers/blank). The response mentions a total expense amount — the absolute value should be approximately 12,257 (within +/-500 tolerance, as the AI may include or exclude edge rows). The key assertion is that the AI read and processed the XLSX data, not that it produced an exact number.

#### TC-032: Conversation persistence across app restart `[AI]`
- Priority: P0
- Preconditions: At least 2 conversation turns (user + assistant) exist in the workbench.
- Steps:
  1. Note the number of messages in the conversation and the text of the last assistant message.
     Expected: At least 2 user messages and 2 assistant messages are visible.
  2. Navigate back to home screen and note the workbench name.
     Expected: Home screen shows the workbench tile.
  3. Quit the app completely and relaunch.
     Expected: Home screen appears with the workbench tile.
  4. Click on the workbench tile to reopen it.
     Expected: The workbench screen opens. The message list contains the same number of messages as before. The last assistant message text matches what was noted in step 1.

#### TC-033: Workshop input blocked while Draft exists
- Priority: P0
- Preconditions: A Draft exists for the current workbench.
- Steps:
  1. Verify the composer field (`AppKeys.workbenchComposerField`) is NOT visible.
     Expected: Instead of the composer, the draft status area is shown with text "Draft in progress" and buttons for "Open Review" (`AppKeys.workbenchReviewButton`) and "Discard" (`AppKeys.workbenchDiscardButton`).
  2. Verify there is no send button visible.
     Expected: `AppKeys.workbenchSendButton` is not found in the widget tree.

---

### 6. Draft Creation and Auto-Apply — Text/CSV

#### TC-040: Auto-draft from staffing prompt (text files) `[AI]`
- Priority: P0
- Preconditions: Consent granted. Workbench has `notes.txt` (staffing notes) and `data.csv` (employee roster). No existing Draft.
- Steps:
  1. Type the following in the composer and click Send:
     "Create two new files:\n1. org_chart.md — an org chart grouped by project (Atlas, Beacon) listing each employee by full name and role.\n2. project_assignments.csv — a CSV with header: name,project,role and one row per employee."
     Expected: The user message appears. The assistant begins processing.
  2. Wait for the assistant response to complete.
     Expected: The assistant acknowledges the request. Tool calls may be visible in the conversation (list_files, read_file, write_text_file). Timeout: 120 seconds.
  3. Wait for the Draft to be created (the review screen auto-opens or the draft banner appears).
     Expected: Either the review screen (`AppKeys.reviewScreen`) appears automatically, OR the draft banner (`AppKeys.workbenchDraftBanner`) appears with text "Draft in progress". Timeout: 30 seconds after assistant response.
  4. If on workbench screen, click "Open Review" (`AppKeys.workbenchReviewButton`).
     Expected: The review screen opens.
  5. Verify the change list (`AppKeys.reviewChangeList`) shows at least one file.
     Expected: At least one entry appears in the change list. Each entry shows a file path and an "ADDED" badge.
  6. Verify the published files via engine API: call `WorkbenchFilesList` and check the draft directory on disk.
     Expected: Draft directory contains at least one `.md` or `.csv` file. The files are parseable (valid UTF-8 text). If `org_chart.md` exists: it contains the text "Atlas" and "Beacon" (case-insensitive). If `project_assignments.csv` exists: it has a header row containing "name" and at least 3 data rows.

#### TC-041: Auto-draft from bank statement analysis `[AI]`
- Priority: P0
- Preconditions: Consent granted. Workbench has `cuentas_octubre_2024_anonymized_draft.xlsx`. No existing Draft.
- Steps:
  1. Type the following in the composer and click Send:
     "Analyze the bank statement and create a file called spending_summary.csv with columns: Category, TransactionCount, TotalAmount. Group transactions by their type (e.g., Pago Movil, Compra Comercio, Recibo, Transferencia, etc.) and calculate the total for each category."
     Expected: The user message appears. The assistant begins processing. Tool calls for reading the XLSX file should occur.
  2. Wait for the assistant response and Draft creation.
     Expected: The assistant response completes. A Draft is created. Timeout: 120 seconds.
  3. Navigate to the review screen.
     Expected: The change list shows `spending_summary.csv` (or similarly named CSV) with "ADDED" badge.
  4. Verify the draft file on disk.
     Expected: The CSV file exists in the draft directory. It is valid CSV (parseable). It has a header row. It has at least 3 data rows (there are multiple transaction categories). The total amounts in the file are all negative numbers (expenses). The sum of all TotalAmount values is approximately -12,257 (within +/-1000 tolerance).

#### TC-042: Auto-draft creates new XLSX sheet from bank data `[AI]`
- Priority: P1
- Preconditions: Consent granted. Workbench has `cuentas_octubre_2024_anonymized_draft.xlsx`. No existing Draft.
- Steps:
  1. Type the following in the composer and click Send:
     "Add a new sheet called 'Summary' to the bank statement file. In this sheet, put a header row with: Category, Count, Total. Then list each transaction category with its count and total amount. At the bottom, add a row with 'TOTAL' and the grand totals."
     Expected: The assistant processes the request using xlsx_operations tool calls.
  2. Wait for Draft creation.
     Expected: A Draft is created. Timeout: 120 seconds.
  3. Navigate to the review screen. Select the XLSX file in the change list.
     Expected: The change list shows the XLSX file with "MODIFIED" badge. The detail pane shows a sheet selector. A "Summary" sheet should be available in the dropdown.
  4. Verify the draft XLSX file on disk using the tool worker or openpyxl.
     Expected: The workbook has a new sheet named "Summary" (or case variation). The sheet has a header row. It has multiple data rows. There is a total row at the bottom.

---

### 7. Draft Creation and Auto-Apply — Office Files

#### TC-050: Create a DOCX report from CSV data `[AI]`
- Priority: P0
- Preconditions: Consent granted. Workbench has `data.csv` (employee roster). No existing Draft.
- Steps:
  1. Type the following in the composer and click Send:
     "Create a Word document called team_report.docx with a heading 'Team Overview', a paragraph describing the team composition, and a summary of each employee's name and role."
     Expected: The assistant processes the request. Tool calls for `read_file` (to read the CSV) and `docx_operations` (to create the document) should occur.
  2. Wait for Draft creation.
     Expected: A Draft is created with `team_report.docx`. Timeout: 120 seconds.
  3. Navigate to review. Select `team_report.docx` in the change list.
     Expected: The file shows "ADDED" badge and "DOCX" type badge. The detail pane shows a page preview (side-by-side, with "Draft" on the right).
  4. Verify the draft DOCX on disk.
     Expected: The file is a valid DOCX (can be opened by python-docx without error). It contains at least one heading element. It contains at least one paragraph with text. It references at least 2 employee names from `data.csv`.

#### TC-051: Modify existing DOCX `[AI]`
- Priority: P1
- Preconditions: Consent granted. Workbench has `simple.docx`. No existing Draft.
- Steps:
  1. Type: "Read the document and add a new section at the end with heading 'Conclusion' and a paragraph summarizing the document's content." Click Send.
     Expected: The assistant reads the file and proposes modifications.
  2. Wait for Draft creation.
     Expected: Draft created with modified `simple.docx`. Timeout: 120 seconds.
  3. Navigate to review. Select `simple.docx`.
     Expected: "MODIFIED" badge. The text extraction diff shows added lines containing "Conclusion". The page preview shows Published (left) and Draft (right) side by side.
  4. Verify the diff panel (`AppKeys.reviewDiffList`).
     Expected: Green-highlighted (added) lines are visible containing the word "Conclusion".

#### TC-052: Create PPTX presentation from data `[AI]`
- Priority: P1
- Preconditions: Consent granted. Workbench has `data.csv`. No existing Draft.
- Steps:
  1. Type: "Create a PowerPoint called team_deck.pptx with 3 slides: 1) Title slide with 'Team Overview'. 2) A slide listing all team members with their roles. 3) A conclusion slide." Click Send.
     Expected: The assistant uses `pptx_operations` to create the presentation.
  2. Wait for Draft creation.
     Expected: Draft created with `team_deck.pptx`. Timeout: 120 seconds.
  3. Navigate to review. Select the PPTX file.
     Expected: "ADDED" badge. The detail pane shows slide preview with navigation (Previous/Next buttons, "Slides" label, "1 / N" counter).
  4. Navigate through slides using the Next button.
     Expected: Each click advances to the next slide. The slide counter updates. At least 2 slides are present.
  5. Verify the draft PPTX on disk.
     Expected: Valid PPTX file. Contains at least 2 slides. At least one slide contains text referencing team members.

#### TC-053: Modify existing XLSX with multi-sheet operations `[AI]`
- Priority: P0
- Preconditions: Consent granted. Workbench has `multi-sheet.xlsx`. No existing Draft.
- Steps:
  1. Type: "Read the spreadsheet. Add a new sheet called 'Summary' with a single cell A1 containing the text 'Summary of all sheets'. In cell A2, list the names of all other sheets separated by commas." Click Send.
     Expected: The assistant reads the file via tool calls, then uses `xlsx_operations` to modify it.
  2. Wait for Draft creation.
     Expected: Draft created with modified `multi-sheet.xlsx`. Timeout: 120 seconds.
  3. Navigate to review. Select the XLSX file.
     Expected: "MODIFIED" badge. The detail pane shows a grid preview with a sheet selector dropdown.
  4. Select "Summary" from the sheet dropdown.
     Expected: The grid preview shows data in the Summary sheet. Cell A1 area is visible.
  5. Verify the draft XLSX on disk.
     Expected: The workbook has a "Summary" sheet. Cell A1 contains "Summary of all sheets" (or close text). Cell A2 is not empty.

---

### 8. Review Screen

#### TC-060: Review shows change list with correct badges
- Priority: P0
- Preconditions: Draft exists with at least one ADDED text file and one MODIFIED office file.
- Steps:
  1. Open the review screen (auto-opened or via `AppKeys.workbenchReviewButton`).
     Expected: The review screen (`AppKeys.reviewScreen`) is visible with title "Review Draft".
  2. Verify the change list (`AppKeys.reviewChangeList`) is populated.
     Expected: At least one entry in the list. Each entry shows: file path, change type badge ("ADDED" or "MODIFIED"), file type badge (e.g., "TXT", "DOCX", "XLSX").
  3. Verify the Publish button (`AppKeys.reviewPublishButton`) and Discard button (`AppKeys.reviewDiscardButton`) are visible in the app bar.
     Expected: Both buttons are present and enabled.

#### TC-061: Review text diff for added text file
- Priority: P0
- Preconditions: Draft contains an ADDED `.md` or `.txt` file.
- Steps:
  1. Click on the added text file in the change list.
     Expected: The detail pane updates. A "Summary" section appears with markdown-rendered text. A diff panel (`AppKeys.reviewDiffList`) appears below.
  2. Verify the diff panel.
     Expected: All lines are shown as added (green background with `+` prefix). The content is the full text of the new file. Line numbers are displayed.

#### TC-062: Review text extraction diff for DOCX
- Priority: P1
- Preconditions: Draft contains a MODIFIED `.docx` file.
- Steps:
  1. Click on the DOCX file in the change list.
     Expected: The detail pane shows: Summary section, text extraction diff, and page preview.
  2. Verify the text extraction diff.
     Expected: The diff shows removed lines (red, from published version) and added lines (green, from draft version). The diff reflects the actual text content changes.
  3. Verify the page preview.
     Expected: Side-by-side view with "Published" label on the left and "Draft" on the right. Page images are rendered. Navigation controls show page count.

#### TC-063: Review XLSX grid preview
- Priority: P1
- Preconditions: Draft contains a MODIFIED `.xlsx` file.
- Steps:
  1. Click on the XLSX file in the change list.
     Expected: The detail pane shows: Summary, text extraction diff, and grid preview.
  2. Verify the grid preview has a sheet selector dropdown.
     Expected: A dropdown is visible showing available sheet names.
  3. Select a sheet from the dropdown.
     Expected: The grid table updates to show the selected sheet's data. Cells with values are displayed.
  4. Click the navigation buttons (next row / previous row).
     Expected: The grid scrolls to show different row ranges.

#### TC-064: Review works offline
- Priority: P1
- Preconditions: Draft exists with changes.
- Steps:
  1. Disable the OpenAI provider via `ProvidersSetEnabled` API call (this simulates no network without actually disconnecting).
     Expected: Provider is disabled.
  2. Open the review screen.
     Expected: The review screen loads. The change list is populated. Diffs render correctly. Previews load. No error about network or provider.
  3. Select various files and verify diffs and previews all load.
     Expected: All review content is available offline. No model calls are made during review.
  4. Re-enable the provider.
     Expected: Provider is re-enabled.

---

### 9. Publish and Discard

#### TC-070: Publish applies Draft atomically `[AI]`
- Priority: P0
- Preconditions: Draft exists with at least one ADDED file (e.g., `org_chart.md` from TC-040).
- Steps:
  1. Open the review screen.
     Expected: Review screen shows the changes.
  2. Click "Publish" (`AppKeys.reviewPublishButton`).
     Expected: The review screen closes. The workbench screen (`AppKeys.workbenchScreen`) reappears. The draft banner (`AppKeys.workbenchDraftBanner`) is NOT visible.
  3. Verify the file list now contains the published files.
     Expected: The newly added files (e.g., `org_chart.md`) appear in the workbench file list as regular files.
  4. Verify via engine API (`DraftGetState`).
     Expected: `has_draft` is `false`.
  5. Verify files exist in the published directory on disk.
     Expected: The files exist at `workbenches/<id>/published/<filename>` and are readable.

#### TC-071: Discard removes Draft, published unchanged `[AI]`
- Priority: P0
- Preconditions: Draft exists with ADDED files that have NOT been published before.
- Steps:
  1. Note the current published file list (before discard).
     Expected: The published directory does not contain the draft-added files.
  2. Open the review screen and click "Discard" (`AppKeys.reviewDiscardButton`).
     Expected: The workbench screen reappears. The draft banner is NOT visible.
  3. Verify the file list does NOT contain the discarded draft files.
     Expected: The files that were only in the draft (never published) are not in the file list.
  4. Verify via engine API (`DraftGetState`).
     Expected: `has_draft` is `false`.
  5. Verify the published directory on disk.
     Expected: The draft-only files do NOT exist in the published directory.

#### TC-072: Draft persists across app restart `[AI]`
- Priority: P1
- Preconditions: Draft exists.
- Steps:
  1. Note the draft state (draft banner visible, file names in draft).
     Expected: Draft banner is present.
  2. Quit the app and relaunch.
     Expected: Home screen appears.
  3. Open the workbench.
     Expected: The draft banner is still present OR the review screen auto-opens. The draft changes are preserved.
  4. Open review and verify the same changes are listed.
     Expected: The change list matches what was seen before the restart.
  5. Discard or publish to clean up.
     Expected: Draft is resolved.

#### TC-073: Publish creates a checkpoint `[AI]`
- Priority: P1
- Preconditions: Draft exists.
- Steps:
  1. Click "Publish" on the review screen.
     Expected: Draft is published. Workbench screen appears.
  2. Click the Checkpoints button (`AppKeys.workbenchCheckpointsButton`).
     Expected: The checkpoints screen (`AppKeys.checkpointsScreen`) opens.
  3. Verify the checkpoints list (`AppKeys.checkpointsList`).
     Expected: At least one checkpoint exists with reason "publish" or description referencing the publish action. The checkpoint has a timestamp.

#### TC-074: Rewind before publish restores published file content `[AI]`
- Priority: P0
- Preconditions: Workbench has a single text file `notes.txt` with known original content (for example, `Original baseline text`). No Draft exists.
- Steps:
  1. Extract `notes.txt` to a temp output folder via `WorkbenchFilesExtract` and record it as `source-notes.txt`.
     Expected: Extract succeeds. `source-notes.txt` content is the baseline reference.
  2. Send a workshop prompt that modifies `notes.txt` (for example: "Rewrite notes.txt as a concise executive summary with different wording"), wait for Draft creation, open review, and click Publish.
     Expected: Publish succeeds. Draft is cleared. A publish checkpoint/system event exists.
  3. Extract `notes.txt` again and save as `new-notes.txt`.
     Expected: `new-notes.txt` differs from `source-notes.txt`.
  4. In the message list (`AppKeys.workbenchMessageList`), click Rewind (`AppKeys.workbenchMessageRewindButton(<message_id>)`) on a message from before the publish-triggering turn and confirm.
     Expected: Rewind completes. Conversation is truncated to the selected point. Any Draft state reflects the rewound point.
  5. Extract `notes.txt` again and save as `old-notes.txt`.
     Expected: `old-notes.txt` is identical to `source-notes.txt` and differs from `new-notes.txt`.

---

### 10. Checkpoints

#### TC-080: Create manual checkpoint
- Priority: P1
- Preconditions: Workbench with published files, no Draft.
- Steps:
  1. Click the Checkpoints button (`AppKeys.workbenchCheckpointsButton`).
     Expected: Checkpoints screen opens.
  2. Click "Create checkpoint" (`AppKeys.checkpointsCreateButton`).
     Expected: A dialog appears with a text field for description and Create/Cancel buttons.
  3. Type "Before analysis changes" in the description field and click Create.
     Expected: The dialog closes. A new checkpoint appears in the list with description "Before analysis changes" and a timestamp.

#### TC-081: Restore checkpoint
- Priority: P1
- Preconditions: At least one checkpoint exists. Workbench has published files that differ from the checkpoint state.
- Steps:
  1. Open the checkpoints screen.
     Expected: At least one checkpoint is listed.
  2. Click "Restore" on the earliest checkpoint.
     Expected: A confirmation dialog appears asking to confirm the restore.
  3. Click "Restore" in the confirmation dialog.
     Expected: The dialog closes. A SnackBar or system event message confirms the restore. The workbench returns to the state captured in that checkpoint.
  4. Verify the published files match the checkpoint state.
     Expected: Files that were added after the checkpoint are removed. Files that existed at the checkpoint time are present with their original content.

#### TC-082: Restore blocked while Draft exists
- Priority: P1
- Preconditions: Draft exists. Checkpoints exist.
- Steps:
  1. Open the checkpoints screen.
     Expected: Checkpoints are listed.
  2. Verify the "Create checkpoint" button is disabled.
     Expected: The button is grayed out with tooltip "Publish or discard Draft to create a checkpoint."
  3. Verify the "Restore" button on each checkpoint is disabled.
     Expected: Each restore button is disabled with tooltip "Publish or discard Draft to restore."

---

### 11. Multi-Provider

#### TC-090: Configure Anthropic key
- Priority: P1
- Preconditions: Settings screen open. Valid `KEENBENCH_ANTHROPIC_API_KEY` available.
- Steps:
  1. Locate the Anthropic provider card in Settings.
     Expected: The card is visible with provider name "Anthropic".
  2. Enter the Anthropic API key in the key field and click Save & Validate.
     Expected: Validation succeeds. Provider status shows "Configured".

#### TC-091: Configure Gemini key
- Priority: P1
- Preconditions: Settings screen open. Valid `KEENBENCH_GEMINI_API_KEY` available.
- Steps:
  1. Locate the Google Gemini provider card in Settings.
     Expected: The card is visible.
  2. Enter the Gemini API key and save.
     Expected: Validation succeeds. Provider status shows "Configured".

#### TC-092: Switch model during conversation `[AI]`
- Priority: P1
- Preconditions: OpenAI and Anthropic both configured. Workbench with files.
- Steps:
  1. Send a message with OpenAI selected (the default). Grant consent.
     Expected: Assistant response arrives from OpenAI.
  2. Switch the model selector to an Anthropic model.
     Expected: Model selector shows the new model name.
  3. Send another message.
     Expected: Consent dialog appears for Anthropic (new provider). Grant consent. The assistant response arrives. Timeout: 90 seconds.
  4. Verify both responses are in the conversation history.
     Expected: Two assistant messages are visible, from different providers.

---

### 12. Bank Statement Analysis Scenarios `[AI]`

These tests use `cuentas_octubre_2024_anonymized_draft.xlsx` to validate real-world data handling.

#### TC-100: Extract transactions above threshold to CSV `[AI]`
- Priority: P1
- Preconditions: Consent granted. Workbench has bank statement XLSX. No Draft.
- Steps:
  1. Type: "Find all transactions in the bank statement where the absolute value of IMPORTE EUR is greater than 200. Create a CSV file called large_transactions.csv with columns: Date, Concept, Amount." Click Send.
     Expected: The assistant reads the XLSX, filters transactions, and creates the CSV.
  2. Wait for Draft creation.
     Expected: Draft created. Timeout: 120 seconds.
  3. Verify the draft CSV on disk.
     Expected: The file is valid CSV. It has a header row with at least Date and Amount columns. Every Amount value has absolute value > 200 (tolerance: allow the AI to interpret > vs >=, but no values with |amount| < 150 should appear). At least 5 rows of data (there are many transactions over 200 in the dataset). All amounts are negative (they are all expenses).

#### TC-101: Create monthly summary in markdown `[AI]`
- Priority: P1
- Preconditions: Consent granted. Workbench has bank statement XLSX. No Draft.
- Steps:
  1. Type: "Create a file called october_summary.md that contains: a heading 'October 2024 Bank Statement Summary', the total number of transactions, the total amount spent, and the beginning and ending balance from the SALDO column." Click Send.
     Expected: The assistant processes the XLSX and creates the markdown file.
  2. Wait for Draft creation.
     Expected: Draft created. Timeout: 120 seconds.
  3. Verify the draft file.
     Expected: The file contains "October" and "2024" (or "october" case-insensitive). It mentions a number of transactions in the range 90-120. It mentions a total amount (absolute value) in the range 10,000-15,000. It mentions a beginning balance around 31,000-32,000 and an ending balance around 10,000-11,000.

#### TC-102: Cross-reference bank statement with text notes `[AI]`
- Priority: P2
- Preconditions: Consent granted. Workbench has bank statement XLSX AND a `budget_notes.txt` file with text: "Monthly budget: Entertainment 500 EUR, Groceries 800 EUR, Transport 200 EUR, Bills 2000 EUR."
- Steps:
  1. Type: "Compare the bank statement spending against the budget in budget_notes.txt. Create a file called budget_vs_actual.csv with columns: Category, Budget, Actual, Difference. Try to map transaction concepts to budget categories." Click Send.
     Expected: The assistant reads both files and creates the comparison.
  2. Wait for Draft creation.
     Expected: Draft created. Timeout: 120 seconds.
  3. Verify the draft CSV.
     Expected: The file is valid CSV with at least a header row and 2+ data rows. Each row has 4 columns. The Budget column contains values from the notes (500, 800, 200, 2000 or similar). The Actual column contains negative numbers derived from the bank statement.

---

### 13. Safety and Error Handling

#### TC-110: Sandbox path traversal blocked
- Priority: P0
- Preconditions: Workbench exists with files. Consent granted.
- Steps:
  1. Via engine API, trigger draft creation. After the proposal is created, read the proposal JSON from disk.
     Expected: The proposal file exists in `meta/workshop/proposals/`.
  2. Modify the proposal JSON to include a write with path `../outside.txt`.
     Expected: The file is modified on disk.
  3. Call `WorkshopApplyProposal` via engine API.
     Expected: The call fails with error code `SANDBOX_VIOLATION` or `VALIDATION_FAILED`. The draft directory does NOT contain `outside.txt`. Published files are unchanged.

#### TC-111: External file access refused in conversation `[AI]`
- Priority: P1
- Preconditions: Workbench has only its own files. Consent granted.
- Steps:
  1. Type: "Read the file at /etc/hosts and tell me what's in it." Click Send.
     Expected: The assistant responds indicating it cannot access files outside the workbench. The response does NOT contain the actual contents of /etc/hosts. The response should mention something about only accessing workbench files.

#### TC-112: Network failure during Workshop `[AI]`
- Priority: P1
- Preconditions: Valid key configured. Workbench with files.
- Steps:
  1. Disable the provider via `ProvidersSetEnabled` API to simulate unavailability.
     Expected: Provider is disabled.
  2. Send a Workshop message.
     Expected: An error appears (dialog or SnackBar) mentioning the provider is not configured or unavailable. The conversation remains intact. No crash occurs.
  3. Re-enable the provider.
     Expected: Provider is re-enabled. Subsequent messages can be sent normally.

#### TC-113: Missing provider key blocks Workshop
- Priority: P0
- Preconditions: No provider key configured (fresh state or key cleared).
- Steps:
  1. Create a workbench and add a file.
     Expected: Workbench created with file.
  2. Type a message in the composer and click Send.
     Expected: A dialog appears (`AppKeys.providerRequiredDialog`) indicating a provider key is required. The dialog has an "Open Settings" button.
  3. Click "Open Settings" (`AppKeys.providerRequiredOpenSettings`).
     Expected: The settings screen opens.

#### TC-114: Clutter bar updates with conversation growth `[AI]`
- Priority: P2
- Preconditions: Workbench with files. Consent granted.
- Steps:
  1. Note the initial clutter bar state (`AppKeys.workbenchClutterBar`).
     Expected: The clutter bar is visible. The level might be "Light" with a low fill.
  2. Send 3-5 messages, each requesting detailed analysis. Wait for each response.
     Expected: After several rounds, the clutter bar fill increases. The level may change from "Light" to "Moderate".
  3. Verify the clutter bar text shows the updated level.
     Expected: The progress bar fill has visibly increased from step 1.

---

### 14. Multi-File Cross-Reference Scenarios `[AI]`

#### TC-120: Merge two CSV files into one `[AI]`
- Priority: P1
- Preconditions: Consent granted. Workbench has `data.csv` (employee roster) and a second CSV `projects.csv` with columns: project, start_date, status. No Draft.
- Steps:
  1. Type: "Merge the employee roster with the projects file. Create team_projects.csv with columns: name, role, project, start_date, status. Match employees to projects based on project name." Click Send.
     Expected: The assistant reads both CSVs and creates the merged file.
  2. Wait for Draft creation.
     Expected: Draft created. Timeout: 120 seconds.
  3. Verify the draft CSV.
     Expected: Valid CSV with the specified header columns. At least 3 data rows. Employee names from `data.csv` appear in the output. Project data from `projects.csv` is included.

#### TC-121: Read PDF and create summary DOCX `[AI]`
- Priority: P2
- Preconditions: Consent granted. Workbench has `report.pdf` (read-only) and no Draft.
- Steps:
  1. Type: "Read the PDF report and create a Word document called report_summary.docx with a heading 'Report Summary' and a paragraph summarizing the key points from the PDF." Click Send.
     Expected: The assistant reads the PDF via tool calls and creates a DOCX.
  2. Wait for Draft creation.
     Expected: Draft created. Timeout: 120 seconds.
  3. Navigate to review.
     Expected: Change list shows `report_summary.docx` with "ADDED" badge. The detail pane shows the document preview.
  4. Verify the draft DOCX.
     Expected: Valid DOCX file. Contains at least one heading. Contains at least one paragraph with non-trivial text (not just placeholders).

---

### 15. XLSX-Specific Operations `[AI]`

#### TC-130: Add column to bank statement `[AI]`
- Priority: P1
- Preconditions: Consent granted. Workbench has bank statement XLSX. No Draft.
- Steps:
  1. Type: "Add a new column F to the Movimientos sheet with header 'TIPO' (type). For each transaction row, classify the CONCEPTO as one of: 'Pago Movil', 'Compra', 'Recibo', 'Transferencia', or 'Otro'. Write the classification in column F." Click Send.
     Expected: The assistant uses xlsx_operations to add the column.
  2. Wait for Draft creation.
     Expected: Draft created. Timeout: 120 seconds.
  3. Verify the draft XLSX on disk.
     Expected: Column F has header "TIPO" (or similar). At least 50 rows have a classification value. The values are from the set: Pago Movil, Compra, Recibo, Transferencia, Otro (or close variations). Rows with "Pago Movil" in CONCEPTO should be classified as "Pago Movil" (spot-check 3-5 rows).

#### TC-131: Create pivot-like summary from multi-sheet XLSX `[AI]`
- Priority: P2
- Preconditions: Consent granted. Workbench has `quarterly_data.xlsx` (4 sheets: Q1-Q4, each with Date, Category, Amount, Description). No Draft.
- Steps:
  1. Type: "Create a summary sheet called 'Annual' that shows total Amount by Category across all 4 quarters. Columns should be: Category, Q1_Total, Q2_Total, Q3_Total, Q4_Total, Grand_Total." Click Send.
     Expected: The assistant reads all 4 sheets and creates the summary.
  2. Wait for Draft creation.
     Expected: Draft created. Timeout: 120 seconds.
  3. Verify the draft XLSX.
     Expected: An "Annual" sheet exists. It has the specified column headers. At least 2 data rows. The Grand_Total column equals Q1+Q2+Q3+Q4 for each row (within rounding tolerance). The Q-totals match the known sums from each sheet.

---

### 16. DOCX-Specific Operations `[AI]`

#### TC-140: Fill document template from CSV data `[AI]`
- Priority: P1
- Preconditions: Consent granted. Workbench has `invoice_template.docx` (with placeholders like {{company}}, {{date}}, {{total}}) and a `client_data.csv` with one row: company, date, item, quantity, price. No Draft.
- Steps:
  1. Type: "Read the invoice template and the client data CSV. Fill in the template placeholders with the data from the CSV. Replace {{company}} with the company name, {{date}} with the date, and {{total}} with quantity * price. Save as the same file." Click Send.
     Expected: The assistant reads both files and modifies the DOCX.
  2. Wait for Draft creation.
     Expected: Draft created. Timeout: 120 seconds.
  3. Verify the draft DOCX.
     Expected: The placeholders are replaced with actual values from the CSV. The company name from the CSV appears in the document. The total value is correct (quantity * price).

---

### 17. PPTX-Specific Operations `[AI]`

#### TC-150: Add slide to existing presentation `[AI]`
- Priority: P1
- Preconditions: Consent granted. Workbench has `slides.pptx`. No Draft.
- Steps:
  1. Type: "Add a new slide at the end of the presentation with the title 'Next Steps' and body text listing 3 action items." Click Send.
     Expected: The assistant uses pptx_operations to add a slide.
  2. Wait for Draft creation.
     Expected: Draft created. Timeout: 120 seconds.
  3. Navigate to review and select the PPTX file.
     Expected: "MODIFIED" badge. Slide preview shows the original plus new slide. The slide counter shows one more slide than the original.
  4. Navigate to the last slide in the preview.
     Expected: The last slide contains "Next Steps" (or similar) as the title.
  5. Verify the draft PPTX.
     Expected: The file has one more slide than the original. The last slide has a title containing "Next Steps".

---

### 18. Workbench Context

This section is written for **manual QA** and uses "soap opera testing": a self-referential, fictional company dataset so context inputs look like real work.

Soap Opera Scenario (Test Story)
- **Company:** KeenBench (fictional startup)
- **Product:** KeenBench (this app)
- **Cast (fictional):** Mira Kwon (CEO), Ethan Park (CTO), Priya Desai (Sales Rep), Luis Alvarez (Lead Engineer)
- **Departments (fictional):**
  - Engineering: CTO + Lead Engineer
  - Ops: CEO
  - Sales/Growth: CEO + Sales Rep

Context Fixtures (KeenBench)
- Fixture directory: `docs/test/fixtures/workbench-context/`
- Text blocks (copy/paste into context):
  - `docs/test/fixtures/workbench-context/keenbench_company_context_v1.txt`
  - `docs/test/fixtures/workbench-context/keenbench_company_context_v2.txt`
  - `docs/test/fixtures/workbench-context/keenbench_department_engineering_brief.txt`
  - `docs/test/fixtures/workbench-context/keenbench_situation_alpha.txt`
  - `docs/test/fixtures/workbench-context/keenbench_situation_beta.txt`
  - `docs/test/fixtures/workbench-context/keenbench_document_style_v1.txt`
- File-upload fixtures (used in Upload file mode):
  - `docs/test/fixtures/workbench-context/keenbench_company_overview.docx`
  - `docs/test/fixtures/workbench-context/keenbench_engineering_department_brief.docx`
  - `docs/test/fixtures/workbench-context/keenbench_company_metrics.xlsx`
  - `docs/test/fixtures/workbench-context/keenbench_pitch_deck.pptx`
  - `docs/test/fixtures/workbench-context/keenbench_security_overview.pdf`
  - `docs/test/fixtures/workbench-context/keenbench_launch_plan.csv`
- Workbench files (used to create Drafts):
  - `docs/test/fixtures/workbench-context/keenbench_weekly_notes.txt`
- Negative / large fixtures:
  - Generated (gitignored): `artifacts/testdata/keenbench_situation_clutter_payload.md`, `artifacts/testdata/keenbench_oversize_roster.csv`
  - Committed: `docs/test/fixtures/workbench-context/keenbench_logo.png`, `docs/test/fixtures/workbench-context/keenbench_unknown.bin`
- Fixture generation command:

  `engine/tools/pyworker/.venv/bin/python scripts/testdata/generate_workbench_context_fixtures.py`

Workbench Context Behavior
- Four fixed categories, one slot per category: company-context, department-context, situation, document-style.
- Add/Reprocess uses synchronous model processing.
- Direct edit saves raw artifact files without skill-validation gate.
- Context mutations are blocked while Draft exists.
- Runtime prompt assembly always injects active context items.
- Clutter warning should appear when context share is high (`>= 0.35`).

Common Setup (Recommended)

Use one Workbench for most cases (TC-160 through TC-170), and a separate fresh Workbench for TC-171.

1. Generate the fixtures (if not already generated):
   Expected: Fixture files exist under `docs/test/fixtures/workbench-context/` and `artifacts/testdata/`.

   `engine/tools/pyworker/.venv/bin/python scripts/testdata/generate_workbench_context_fixtures.py`
2. Create a new Workbench named `WB Context - KeenBench Soap Opera`.
   Expected: The Workbench opens.
3. Add `docs/test/fixtures/workbench-context/keenbench_weekly_notes.txt` to the Workbench.
   Expected: The file appears in the file list.
4. Grant egress consent for the active provider/model by sending a harmless Workshop message and clicking "Continue" on the consent dialog.
   Expected: Consent is granted and an assistant response arrives. Timeout: 60 seconds.

   Message to send: `Reply with only: ok`
5. Ensure no Draft exists (discard or publish any Draft before running context-mutation tests).
   Expected: Composer is visible and context Add/Edit/Delete are enabled (unless the test case requires a Draft).

#### TC-160: Open context overview and verify fixed categories
- Priority: P0
- Preconditions: Workbench exists. No Draft. No context items yet.
- Steps:
  1. Open the target Workbench and click the sidebar button labeled "Add Context".
     Expected: The "Workbench Context" screen opens.
  2. Verify the four category cards are present.
     Expected: The cards are exactly: "Company-Wide Information", "Department-Specific Information", "Situation", and "Document Style & Formatting".
  3. On a fresh Workbench with no context items, verify empty-card actions.
     Expected: Each card shows an enabled "Add" button. "Inspect" and "Delete" are disabled for empty categories.

#### TC-161: Process company context from text and verify skill artifact contract `[AI]`
- Priority: P0
- Preconditions: Valid provider key configured and enabled. Egress consent already granted for the active provider/model. No Draft.
- Steps:
  1. Open "Add Context". On "Company-Wide Information", click "Add".
     Expected: A modal opens with "Write text" selected and a multi-line text field.
  2. Paste the full contents of `docs/test/fixtures/workbench-context/keenbench_company_context_v1.txt` into the text field.
     Expected: The pasted text includes `QA marker: KEENBENCH_COMPANY_CONTEXT=V1`.
  3. Click "Process".
     Expected: Processing completes within 120 seconds. The modal closes and "Company-Wide Information" becomes active with a non-empty summary (the card shows "Edit" and "Inspect" enabled).
  4. Click "Inspect" on "Company-Wide Information".
     Expected: The artifact includes at least `SKILL.md` and `references/summary.md`, both non-empty.
  5. In the `SKILL.md` section, validate the frontmatter is present.
     Expected: The content begins with YAML frontmatter and contains `name: company-context` plus a non-empty `description:`.
  6. Click "Close". Click "Edit" for "Company-Wide Information".
     Expected: The modal opens in "Write text" mode with the original source text pre-filled.
  7. Replace the text field contents with the full contents of `docs/test/fixtures/workbench-context/keenbench_company_context_v2.txt`, then click "Reprocess".
     Expected: Processing completes within 120 seconds, the card remains a single slot, and the summary/artifact updates (the Edit dialog now pre-fills with `QA marker: KEENBENCH_COMPANY_CONTEXT=V2`).

#### TC-162: Process department context from file mode with note persistence `[AI]`
- Priority: P0
- Preconditions: Valid provider configured and enabled. Egress consent already granted for the active provider/model. No Draft. Fixture file exists: `docs/test/fixtures/workbench-context/keenbench_engineering_department_brief.docx`.
- Steps:
  1. Open "Add Context". On "Department-Specific Information", click "Add".
     Expected: The processing modal opens.
  2. Switch to "Upload file", click "Choose file", and select `docs/test/fixtures/workbench-context/keenbench_engineering_department_brief.docx`.
     Expected: The selected path appears in the file path field.
  3. Paste this note exactly into the note field: `QA note: KEENBENCH_DEPT_NOTE=ENG-2026-02-13. Use this as Engineering department context; preserve terminology.`
     Expected: The note field contains the text exactly as entered.
  4. Click "Process".
     Expected: Processing completes within 120 seconds and the "Department-Specific Information" card becomes active with a non-empty summary.
  5. Click "Inspect" on "Department-Specific Information".
     Expected: The artifact includes at least `SKILL.md` and `references/summary.md`, both non-empty.
  6. Click "Close". Click "Edit" on "Department-Specific Information".
     Expected: The modal opens with "Upload file" selected and the note field pre-filled with `QA note: KEENBENCH_DEPT_NOTE=ENG-2026-02-13. Use this as Engineering department context; preserve terminology.` (the file path may show "No file selected" and is not required to be persisted).

#### TC-163: Process situation context and verify injection artifact shape `[AI]`
- Priority: P0
- Preconditions: Valid provider configured and enabled. Egress consent already granted for the active provider/model. No Draft.
- Steps:
  1. Open "Add Context". On "Situation", click "Add".
     Expected: The processing modal opens in "Write text" mode.
  2. Paste the full contents of `docs/test/fixtures/workbench-context/keenbench_situation_alpha.txt` into the text field.
     Expected: The pasted text includes `QA marker: KEENBENCH_SITUATION_TAG=HNDY-LAUNCH-ALPHA-4187`.
  3. Click "Process".
     Expected: Processing completes within 120 seconds and the "Situation" card becomes active with a non-empty summary.
  4. Click "Inspect" on "Situation".
     Expected: The artifact file list contains `context.md` (and does not require `SKILL.md`). `context.md` is non-empty.

#### TC-164: Process document-style context and verify style artifact shape `[AI]`
- Priority: P0
- Preconditions: Valid provider configured and enabled. Egress consent already granted for the active provider/model. No Draft.
- Steps:
  1. Open "Add Context". On "Document Style & Formatting", click "Add".
     Expected: The processing modal opens in "Write text" mode.
  2. Paste the full contents of `docs/test/fixtures/workbench-context/keenbench_document_style_v1.txt` into the text field.
     Expected: The pasted text includes `QA marker: KEENBENCH_DOC_STYLE=V1`.
  3. Click "Process".
     Expected: Processing completes within 120 seconds and the "Document Style & Formatting" card becomes active with a non-empty summary.
  4. Click "Inspect" on "Document Style & Formatting".
     Expected: The artifact includes `SKILL.md` and `references/style-rules.md`, both non-empty.
  5. In the `SKILL.md` section, validate the frontmatter is present.
     Expected: The content contains `name: document-style` plus a non-empty `description:`.

#### TC-165: Direct edit lifecycle and reprocess overwrite warning `[AI]`
- Priority: P0
- Preconditions: "Company-Wide Information" is active (TC-161 completed). No Draft.
- Steps:
  1. Open "Add Context". On "Company-Wide Information", click "Inspect".
     Expected: The inspect modal opens with a "Direct Edit" toggle and a `SKILL.md` section.
  2. Toggle "Direct Edit" ON.
     Expected: The text fields become editable and the "Save Direct Edit" button becomes enabled.
  3. In the `SKILL.md` field, append this exact line at the very end of the file (add a new line if needed): `MANUAL_EDIT_MARKER=KEENBENCH_CONTEXT_EDIT_1`
     Expected: The marker line is present in the field.
  4. Click "Save Direct Edit".
     Expected: Save succeeds, the modal closes, and the "Company-Wide Information" card shows a "Manually edited" indicator.
  5. Click "Edit" for "Company-Wide Information", then click "Reprocess".
     Expected: A confirmation dialog appears warning that reprocessing will overwrite manual edits, with "Cancel" and "Proceed".
  6. Click "Cancel".
     Expected: Reprocessing does not run. The "Manually edited" indicator remains.
  7. Click "Inspect" again and verify the marker still exists.
     Expected: `SKILL.md` still contains `MANUAL_EDIT_MARKER=KEENBENCH_CONTEXT_EDIT_1`.
  8. Click "Close". Click "Edit" again and click "Reprocess" again, then click "Proceed".
     Expected: Processing completes within 120 seconds. The "Manually edited" indicator clears. `SKILL.md` no longer contains `MANUAL_EDIT_MARKER=KEENBENCH_CONTEXT_EDIT_1` (manual edits were overwritten).

#### TC-166: Always-inject behavior and forward-only context updates in Workshop `[AI]`
- Priority: P0
- Preconditions: Valid provider configured and enabled. Egress consent already granted for the active provider/model. No Draft.
- Steps:
  1. Ensure "Situation" is active and up to date by reprocessing it with `docs/test/fixtures/workbench-context/keenbench_situation_alpha.txt`.
     Expected: Processing completes within 120 seconds.
  2. In Workshop, send this exact message: `Reply with only the full value of KEENBENCH_SITUATION_TAG from Workbench Context. Output only the value.`
     Expected: The assistant response contains `HNDY-LAUNCH-ALPHA-4187`. Timeout: 60 seconds.
  3. Reprocess "Situation" with `docs/test/fixtures/workbench-context/keenbench_situation_beta.txt`.
     Expected: Processing completes within 120 seconds.
  4. Send the same message again.
     Expected: The assistant response contains `HNDY-LAUNCH-BETA-9026`. Timeout: 60 seconds.
  5. Verify forward-only behavior in history.
     Expected: The earlier assistant response from step 2 still shows `HNDY-LAUNCH-ALPHA-4187` (it is not rewritten), while the latest response shows `HNDY-LAUNCH-BETA-9026`.

#### TC-167: Context mutations blocked while Draft exists `[AI]`
- Priority: P0
- Preconditions: At least one active context item exists. Valid provider configured and enabled. An editable workbench file is available to create a Draft.
- Steps:
  1. Add `docs/test/fixtures/workbench-context/keenbench_weekly_notes.txt` to the Workbench file list.
     Expected: The file appears in the file list as an editable text file.
  2. In Workshop, send this exact message to force a Draft: `Open keenbench_weekly_notes.txt and append a new bullet under Updates: "- QA marker: DRAFT_BLOCK_TEST=1". Save the file.`
     Expected: A Draft is created (Draft banner appears and the composer is no longer available). Timeout: 120 seconds.
  3. Click "Add Context" in the sidebar.
     Expected: The context overview opens, but "Add"/"Edit" and "Delete" buttons are disabled (tooltip indicates Draft must be published or discarded).
  4. Click "Inspect" on an active context item (for example, "Company-Wide Information").
     Expected: In the inspect modal, "Direct Edit" toggle is disabled, "Reprocess" is disabled, and "Save Direct Edit" is disabled.

#### TC-168: Context file-input variants (supported and blocked) `[AI]`
- Priority: P1
- Preconditions: Valid provider configured and enabled. Egress consent already granted for the active provider/model. No Draft. Fixture generator has been run (`scripts/testdata/generate_workbench_context_fixtures.py`) so the required files exist.
- Steps:
  1. Open "Add Context" to reach the "Workbench Context" screen.
     Expected: The four category cards are visible.
  2. Process Company-Wide from a DOCX file:
     Expected: Processing succeeds within 120 seconds and "Company-Wide Information" becomes active. "Inspect" shows `SKILL.md` and `references/summary.md` (both non-empty).

     - Click "Add" (or "Edit") on "Company-Wide Information"
     - Select "Upload file"
     - Choose `docs/test/fixtures/workbench-context/keenbench_company_overview.docx`
     - Click "Process"/"Reprocess"
  3. Repeat step 2 for Department from a PDF file:
     Expected: Processing succeeds within 120 seconds and "Department-Specific Information" becomes active. "Inspect" shows `SKILL.md` and `references/summary.md` (both non-empty).

     - "Department-Specific Information" -> "Add"/"Edit" -> "Upload file"
     - Choose `docs/test/fixtures/workbench-context/keenbench_security_overview.pdf`
     - Click "Process"/"Reprocess"
  4. Repeat step 2 for Situation from a CSV file:
     Expected: Processing succeeds within 120 seconds and "Situation" becomes active. "Inspect" shows `context.md` (non-empty).

     - "Situation" -> "Add"/"Edit" -> "Upload file"
     - Choose `docs/test/fixtures/workbench-context/keenbench_launch_plan.csv`
     - Click "Process"/"Reprocess"
  5. Repeat step 2 for Document Style from a PPTX file:
     Expected: Processing succeeds within 120 seconds and "Document Style & Formatting" becomes active. "Inspect" shows `SKILL.md` and `references/style-rules.md` (both non-empty).

     - "Document Style & Formatting" -> "Add"/"Edit" -> "Upload file"
     - Choose `docs/test/fixtures/workbench-context/keenbench_pitch_deck.pptx`
     - Note: `Focus on layout and heading rules; preserve hex colors.`
     - Click "Process"/"Reprocess"
  6. Repeat step 2 for Company-Wide from an XLSX file:
     Expected: Processing succeeds within 120 seconds. Company-Wide remains active and "Inspect" shows `SKILL.md` and `references/summary.md` (both non-empty).

     - "Company-Wide Information" -> "Edit" -> "Upload file"
     - Choose `docs/test/fixtures/workbench-context/keenbench_company_metrics.xlsx`
     - Click "Reprocess"
  7. Attempt to reprocess Company-Wide with an image file (should be blocked):
     Expected: A "Processing failed" dialog appears (mentions unsupported image inputs or unsupported file type). After clicking "Cancel", Company-Wide remains active and unchanged (Inspect still shows the last successful artifact files).

     - "Company-Wide Information" -> "Edit" -> "Upload file"
     - Choose `docs/test/fixtures/workbench-context/keenbench_logo.png`
     - Click "Reprocess"
  8. Repeat step 7 with an unknown binary file:
     Expected: A "Processing failed" dialog appears (mentions unsupported file type). After clicking "Cancel", Company-Wide remains active and unchanged.

     - Choose `docs/test/fixtures/workbench-context/keenbench_unknown.bin`
  9. Repeat step 7 with a >25MB CSV file:
     Expected: A "Processing failed" dialog appears (mentions size limit, 25MB). After clicking "Cancel", Company-Wide remains active and unchanged.

     - Choose `artifacts/testdata/keenbench_oversize_roster.csv`
  10. Create a symlink and repeat step 7 with the symlink path:
      Expected: A "Processing failed" dialog appears (mentions symlinks are not allowed). After clicking "Cancel", Company-Wide remains active and unchanged.

      - Create symlink (Linux/macOS): `ln -s "$(pwd)/docs/test/fixtures/workbench-context/keenbench_company_context_v1.txt" /tmp/keenbench_company_context_link.txt`
      - Choose `/tmp/keenbench_company_context_link.txt`

#### TC-169: Clutter warning reflects large context share
- Priority: P1
- Preconditions: Active situation context exists. No Draft.
- Steps:
  1. Open "Add Context". On "Situation", click "Inspect".
     Expected: The inspect modal opens.
  2. Toggle "Direct Edit" ON.
     Expected: The `context.md` field becomes editable and "Save Direct Edit" becomes enabled.
  3. Replace the entire `context.md` content with the full contents of `artifacts/testdata/keenbench_situation_clutter_payload.md`.
     Expected: The text field contains a very large payload (much larger than a typical context item).
  4. Click "Save Direct Edit".
     Expected: Save succeeds. The "Situation" card shows a "Manually edited" indicator.
  5. Return to the Workbench screen.
     Expected: A warning appears: "Context is using a large share of the prompt window. Consider shortening context items."

#### TC-170: Processing failure recovery (Retry/Cancel) with no partial save `[AI]`
- Priority: P1
- Preconditions: Category is empty. Valid provider configured and enabled. Egress consent already granted for the active provider/model. No Draft.
- Steps:
  1. Open "Add Context". On "Company-Wide Information", click "Add". Paste `docs/test/fixtures/workbench-context/keenbench_company_context_v1.txt` into the text field.
     Expected: The dialog is ready to process (no Draft exists).
  2. Disconnect the machine from the network (for example: turn off WiFi or unplug the network).
     Expected: The OS indicates the machine is offline.
  3. Click "Process".
     Expected: A "Processing failed" dialog appears within 30 seconds, with error text indicating a network/provider failure. The dialog offers "Retry" and "Cancel".
  4. Click "Retry" once (while still offline).
     Expected: The request fails again and the failure dialog reappears.
  5. Click "Cancel" on the failure dialog.
     Expected: No context item is saved; "Company-Wide Information" remains empty (card still shows "Add", and "Inspect"/"Delete" are disabled).
  6. Reconnect the machine to the network.
     Expected: The OS indicates the machine is online.
  7. In the same processing dialog, click "Process" again.
     Expected: Processing succeeds within 120 seconds and "Company-Wide Information" becomes active.

#### TC-171: Context processing enforces egress consent scope `[AI]`
- Priority: P1
- Preconditions: Valid provider key configured and enabled. Fresh Workbench with no granted Workshop consent for the active provider/model.
- Steps:
  1. Create a brand-new Workbench (new name) so there is no prior consent for this scope.
     Expected: The new Workbench opens with an empty conversation.
  2. Add `docs/test/fixtures/workbench-context/keenbench_weekly_notes.txt` to the Workbench file list.
     Expected: The file appears in the file list.
  3. Without sending any Workshop message yet, attempt to process Company-Wide context:
     Expected: Processing fails with an error that includes `EGRESS_CONSENT_REQUIRED` (or equivalent consent-required wording), and the Company-Wide category remains empty.

     - Open "Add Context" -> "Company-Wide Information" -> "Add"
     - Paste `docs/test/fixtures/workbench-context/keenbench_company_context_v1.txt`
     - Click "Process"
  4. Close the context dialog(s). Trigger the consent flow from Workshop by sending a harmless message: `Reply with only: ok`
     Expected: A "Consent required" dialog appears listing the workbench file(s). Click "Continue" to grant consent.
  5. Return to "Add Context" and retry the Company-Wide processing from step 3.
     Expected: Processing succeeds within 120 seconds and the Company-Wide context item becomes active.

### 20. RPI Workflow

#### TC-RPI-01: Full RPI cycle emits phase notifications `[AI]`
- Priority: P0
- Preconditions: Valid OpenAI key, no Draft, Workbench with at least one file.
- Steps:
  1. Send a Workshop prompt that requires file edits.
     Expected: Phase notifications appear in order: `research`, `plan`, `implement`, `summary`.
  2. Observe implement progress updates.
     Expected: `WorkshopImplementProgress` updates show current/total item progress.
  3. Wait for completion.
     Expected: A single assistant summary message appears in conversation.

#### TC-RPI-02: Internal R/P/I chatter is not persisted to chat `[AI]`
- Priority: P0
- Preconditions: Same as TC-RPI-01.
- Steps:
  1. Run a prompt that requires multiple implement items.
     Expected: Conversation contains user message(s) plus final assistant summary only; no internal research/plan/item transcripts.

#### TC-RPI-03: Research and plan artifacts are internal-only `[AI]`
- Priority: P1
- Preconditions: Completed RPI run with file edits.
- Steps:
  1. Inspect Workbench file list in UI.
     Expected: `_rpi/research.md` and `_rpi/plan.md` are not shown in user-visible file list.
  2. Inspect engine metadata directory on disk.
     Expected: `meta/workshop/_rpi/research.md` and `meta/workshop/_rpi/plan.md` exist.

#### TC-RPI-04: Implement retry then fail marker progression `[AI]`
- Priority: P1
- Preconditions: Prompt likely to cause one item failure (or simulate transient provider/tool issue).
- Steps:
  1. Trigger run and observe implement phase.
     Expected: Failing item is retried once.
  2. After retry failure, continue run.
     Expected: Item is marked `[!] ... [Failed: ...]` and later items continue.
  3. Final summary.
     Expected: Summary reports failed item(s) and completed item(s).

#### TC-RPI-05: Resumability after interruption `[AI]`
- Priority: P0
- Preconditions: Long-running implement prompt with multiple items.
- Steps:
  1. Start run and interrupt app/engine during implement phase.
     Expected: Run stops mid-work.
  2. Reopen workbench and run agent again.
     Expected: Workflow resumes from existing `_rpi` state and continues from first pending plan item.

#### TC-RPI-06: New user message clears stale RPI state `[AI]`
- Priority: P0
- Preconditions: Existing `_rpi` artifacts from prior run.
- Steps:
  1. Send a new user prompt.
     Expected: Previous `_rpi` state is cleared before next run begins.
  2. Run agent.
     Expected: New Research phase starts from fresh state (no reuse of prior plan artifact).

#### TC-RPI-07: Plan amendment cap enforcement `[AI]`
- Priority: P1
- Preconditions: Prompt likely to discover sub-items during implement.
- Steps:
  1. Run workflow where model appends new `- [ ] N. ...` lines in implement final text.
     Expected: Engine appends new items to plan.
  2. Continue run with repeated amendments.
     Expected: Total items do not exceed 2x original count; excess appended items are dropped.

#### TC-RPI-08: Bank statement category breakdown workflow `[AI]`
- Priority: P0
- Preconditions: Add `engine/testdata/real/cuentas_octubre_2024_anonymized_draft.xlsx`.
- Steps:
  1. Send prompt: "Break down expenses by category into separate sheets in a new Excel file."
     Expected: Draft `.xlsx` is created with multiple category sheets.
  2. Validate result structurally.
     Expected: Conversation shows summary-only assistant output; internal `_rpi` artifacts are not listed in files.
  3. Validate totals.
     Expected: Sum of expense outputs equals `-12,257.08` (allowing minor rounding tolerance if formulas are used).

---

## Accessibility Smoke Matrix (Core v1)

#### TC-A11Y-01: Workbench keyboard-only flow
- Priority: P0
- Preconditions: Workbench has at least one file and no draft.
- Steps:
  1. Navigate to Workbench and use skip links to jump to main content and composer.
     Expected: Skip links are reachable via keyboard and move focus to target regions.
  2. Use keyboard only to compose and send a message.
     Expected: Message sends without mouse interaction.
  3. Trigger review/discard actions when draft is present.
     Expected: Review and discard controls are keyboard reachable and visible when focused.

#### TC-A11Y-02: Screen reader status announcements
- Priority: P0
- Preconditions: VoiceOver (macOS) or NVDA (Windows) enabled.
- Steps:
  1. Start an assistant run from Workbench.
     Expected: Screen reader announces generation/status transitions (start/complete, tool activity, draft ready).
  2. Change model from the Workbench selector.
     Expected: Current model and model-change announcement are spoken.
  3. Trigger an actionable error (e.g. provider disabled).
     Expected: Error summary region is announced and focusable.

#### TC-A11Y-03: Review keyboard + semantics smoke
- Priority: P0
- Preconditions: A draft exists with at least one changed file.
- Steps:
  1. Open Review and use skip links to jump between file list and detail pane.
     Expected: Focus moves to the requested regions.
  2. Navigate changed files with keyboard and select a file.
     Expected: File selection updates the pane and announces “Showing diff for …”.
  3. Navigate diff/preview controls (previous/next page or slide) using keyboard.
     Expected: Controls are reachable and labeled for assistive tech.

#### TC-A11Y-04: Primary screen-reader platform check
- Priority: P1
- Preconditions: Run once per release on primary matrix.
- Steps:
  1. Execute TC-A11Y-01 through TC-A11Y-03 on:
     Expected: VoiceOver on macOS and NVDA on Windows pass with no keyboard traps and no missing primary labels.
  2. Spot-check on Narrator (Windows) and Orca (Linux).
     Expected: Core navigation and announcements remain usable; document any gaps for v1.5 audit.

---

## Traceability Matrix

| Requirement | Source | Test cases |
|---|---|---|
| Workbench -> Workshop -> Propose -> Apply -> Review -> Publish flow | M0 plan | TC-040, TC-041, TC-060, TC-070 |
| Sandbox boundary (no path escape) | PRD FR1, ADR-0006 | TC-110, TC-111 |
| Egress consent before model call | PRD SR2/SR3 | TC-020 through TC-025, TC-171 |
| Real models only (no fake AI) | CLAUDE.md testing policy | All `[AI]` tests |
| Workbench file add semantics (limits, duplicates, symlinks) | Workbench design | TC-011 through TC-014 |
| Draft lifecycle (single draft, blocked actions) | Draft-publish design | TC-016, TC-033, TC-082, TC-167 |
| Conversation persistence | Workshop design | TC-032 |
| Provider key management | ADR-0004 | TC-003, TC-004, TC-006 |
| Provider enable/disable gating | Multi-model design | TC-005, TC-112, TC-113 |
| Multi-provider support | M2 plan | TC-090 through TC-092 |
| Checkpoints create/restore | M2 plan | TC-073, TC-074, TC-080 through TC-082 |
| Office file read/write (DOCX/XLSX/PPTX) | M1 plan | TC-050 through TC-053, TC-130, TC-140, TC-150 |
| Read-only files (PDF, images, ODT) | M1 plan | TC-009, TC-121 |
| Opaque file support | M1 plan | TC-010 |
| Review offline (no model calls during review) | M0 plan | TC-064 |
| Publish creates checkpoint | M2 plan | TC-073 |
| Rewind restores published state across publish boundary | Workshop + checkpoints design | TC-074 |
| Clutter bar updates | M2 plan | TC-114, TC-169 |
| Draft gating on workbench mutations | M3 plan | TC-016 |
| Workbench context (fixed categories, process/reprocess, direct edit, runtime injection) | Workbench Context PRD/Design (FR1.5) | TC-160 through TC-171 |
| RPI phased Workshop workflow (Research/Plan/Implement/Summary) | RPI workflow design/plan | TC-RPI-01 through TC-RPI-08 |
| Accessibility baseline (keyboard-only, semantics, announcements, contrast/non-color indicators) | Accessibility PRD/Design | TC-A11Y-01 through TC-A11Y-04 |
| Agent Skills compliance for processed context artifacts | Workbench Context skill compliance rules | TC-161, TC-162, TC-164, TC-168 |
| Bank statement real-world XLSX handling | Testing policy | TC-031, TC-041, TC-042, TC-100 through TC-102, TC-130 |

---

## Notes

- Test data files referenced as `engine/testdata/real/` must be copied into the repo (gitignored if sensitive).
- Synthetic test data (world_gdp.csv, invoice_template.docx, quarterly_data.xlsx, etc.) should be generated as part of test setup. Scripts for generation belong in `scripts/testdata/`.
- AI test timeouts should be generous (60-120s per model call). If a test consistently times out, investigate model latency rather than reducing assertion quality.
- When a test fails on assertion, capture the actual draft file content for debugging. Do not make the assertion looser — investigate why the model produced unexpected output.
- Run the full test suite with `KEENBENCH_DEBUG=1` to capture engine logs for failure investigation.
