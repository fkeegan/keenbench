# KeenBench — Test Plan: File-Type-Specific Operations

> Extracted from the [master test plan](../test-plan.md). This section covers multi-file cross-reference, XLSX, DOCX, and PPTX specific operation tests.

## Policy

**Every test that involves AI interaction MUST use real model API calls. No exceptions.**
No fake/mock AI clients. No `KEENBENCH_FAKE_OPENAI`. No conditional branching on fake vs real mode.
Assertions on AI output must be structural or numerical — never exact-text-match on prose.
See `CLAUDE.md` for the full testing policy.

## Test Environment

- Linux desktop (X11). E2E harness targets `flutter test integration_test -d linux`.
- Network access to: `api.openai.com`, `auth.openai.com`, `api.anthropic.com`, `generativelanguage.googleapis.com`, `api.mistral.ai`.
- Valid API keys in `.env`:
  - `KEENBENCH_OPENAI_API_KEY` (required for all AI tests)
  - `KEENBENCH_ANTHROPIC_API_KEY` (required for multi-provider tests)
  - `KEENBENCH_GEMINI_API_KEY` (required for multi-provider tests)
  - `KEENBENCH_MISTRAL_API_KEY` (required for multi-provider tests)
- Clean app data directory per test run (`KEENBENCH_DATA_DIR` pointed to temp dir).
- Python venv with tool worker dependencies (`engine/tools/pyworker/.venv`).

## Test Data

### Bundled fixtures (in repo)

| File | Location | Description |
|------|----------|-------------|
| `data.csv` | `app/integration_test/support/` | Employee roster CSV (name, role, location, availability) with 5 rows |
| `report.pdf` | `engine/testdata/office/` | PDF report (read-only) |
| `slides.pptx` | `engine/testdata/office/` | PowerPoint with 2-3 slides |

### Synthetic data (`engine/testdata/synthetic/`, generated by `scripts/testdata/generate_fixtures.py`)

| File | Purpose | Specification |
|------|---------|--------------|
| `projects.csv` | Multi-file merge test | CSV with columns: Project, Start Date, Status. 2 rows (Atlas, Beacon matching data.csv). |
| `quarterly_data.xlsx` | Multi-sheet analysis test | 4 sheets (Q1-Q4), each with columns: Date, Category, Amount, Description. 12 rows per sheet. Known totals: Q1=4460.99, Q2=5052.99, Q3=4484.99, Q4=5963.00, Grand=19961.97. |
| `invoice_template.docx` | DOCX template fill test | Word document with placeholder fields: {{company}}, {{date}}, {{items_table}}, {{total}}. Heading + table structure. |
| `client_data.csv` | Template fill data source | CSV with one row: Acme Corp, 2026-03-01, Widget, 50, 24.99. |

## Conventions

- **Priority:** P0 = must-pass, P1 = important, P2 = nice-to-have.
- **IDs:** `TC-###`. No milestone prefix — test cases apply across milestones.
- **AI tests:** Marked with `[AI]` tag. These MUST use real model calls.
- **Manual-only tests:** Marked with `[MANUAL ONLY]` and `Runner: Human only`.
- **Manual-only skip rule for AI agents:** Skip these cases with reason `Skipped: manual browser OAuth required (OpenAI Codex auth callback flow).`
- **Steps format:** Each step is an atomic action followed by `Expected:` with the verifiable result.
- **Timeout convention:** AI-driven steps use 60-120s timeouts unless noted.

## UI Keys Reference

Key elements for this section:
- `AppKeys.workbenchComposerField`, `AppKeys.workbenchSendButton`
- `AppKeys.workbenchDraftBanner`, `AppKeys.workbenchReviewButton`
- `AppKeys.reviewScreen`, `AppKeys.reviewChangeList`

## Office File Operations

The engine uses a Python tool worker (`engine/tools/pyworker/`) for office file operations:
- `docx_operations`: Create and modify Word documents (headings, paragraphs, tables)
- `xlsx_operations`: Create and modify Excel workbooks (sheets, cells, formulas)
- `pptx_operations`: Create and modify PowerPoint presentations (slides, text, layouts)

---

## Test Cases

### 14. Multi-File Cross-Reference Scenarios `[AI]`

#### TC-120: Merge two CSV files into one `[AI]`
- Priority: P1
- Preconditions: Consent granted. Workbench has `data.csv` (employee roster) and a second CSV `projects.csv` with columns: project, start_date, status. No Draft.
- Steps:
  1. Type: "Merge the employee roster with the projects file. Create team_projects.csv with columns: name, role, project, start_date, status. Match employees to projects based on project name." Click Send.
     Expected: The assistant reads both CSVs and creates the merged file.
  2. Wait for Draft creation.
     Expected: Draft created. Timeout: 120 seconds.
  3. Verify the draft CSV.
     Expected: Valid CSV with the specified header columns. At least 3 data rows. Employee names from `data.csv` appear in the output. Project data from `projects.csv` is included.

#### TC-121: Read PDF and create summary DOCX `[AI]`
- Priority: P2
- Preconditions: Consent granted. Workbench has `report.pdf` (read-only) and no Draft.
- Steps:
  1. Type: "Read the PDF report and create a Word document called report_summary.docx with a heading 'Report Summary' and a paragraph summarizing the key points from the PDF." Click Send.
     Expected: The assistant reads the PDF via tool calls and creates a DOCX.
  2. Wait for Draft creation.
     Expected: Draft created. Timeout: 120 seconds.
  3. Navigate to review.
     Expected: Change list shows `report_summary.docx` with "ADDED" badge. The detail pane shows the document preview.
  4. Verify the draft DOCX.
     Expected: Valid DOCX file. Contains at least one heading. Contains at least one paragraph with non-trivial text (not just placeholders).

---

### 15. XLSX-Specific Operations `[AI]`

#### TC-130: Add column to bank statement `[AI]`
- Priority: P1
- Preconditions: Consent granted. Workbench has bank statement XLSX (`engine/testdata/real/cuentas_octubre_2024_anonymized_draft.xlsx`). No Draft.
- Steps:
  1. Type: "Add a new column F to the Movimientos sheet with header 'TIPO' (type). For each transaction row, classify the CONCEPTO as one of: 'Pago Movil', 'Compra', 'Recibo', 'Transferencia', or 'Otro'. Write the classification in column F." Click Send.
     Expected: The assistant uses xlsx_operations to add the column.
  2. Wait for Draft creation.
     Expected: Draft created. Timeout: 120 seconds.
  3. Verify the draft XLSX on disk.
     Expected: Column F has header "TIPO" (or similar). At least 50 rows have a classification value. The values are from the set: Pago Movil, Compra, Recibo, Transferencia, Otro (or close variations). Rows with "Pago Movil" in CONCEPTO should be classified as "Pago Movil" (spot-check 3-5 rows).

#### TC-131: Create pivot-like summary from multi-sheet XLSX `[AI]`
- Priority: P2
- Preconditions: Consent granted. Workbench has `quarterly_data.xlsx` (4 sheets: Q1-Q4, each with Date, Category, Amount, Description). No Draft.
- Steps:
  1. Type: "Create a summary sheet called 'Annual' that shows total Amount by Category across all 4 quarters. Columns should be: Category, Q1_Total, Q2_Total, Q3_Total, Q4_Total, Grand_Total." Click Send.
     Expected: The assistant reads all 4 sheets and creates the summary.
  2. Wait for Draft creation.
     Expected: Draft created. Timeout: 120 seconds.
  3. Verify the draft XLSX.
     Expected: An "Annual" sheet exists. It has the specified column headers. At least 2 data rows. The Grand_Total column equals Q1+Q2+Q3+Q4 for each row (within rounding tolerance). The Q-totals match the known sums from each sheet.

#### TC-132: New XLSX workbook avoids empty default sheet leakage `[AI]`
- Priority: P1
- Preconditions: Consent granted. Workbench has no existing `report.xlsx` draft file. No Draft.
- Steps:
  1. Send a prompt that creates a new workbook with one intended sheet (for example: "Create report.xlsx with one sheet named Summary and set A1='Metric', B1='Value'.").
     Expected: Draft created with `report.xlsx`. Timeout: 120 seconds.
  2. Inspect the workbook in review and/or via local workbook inspection.
     Expected: Only intended sheet(s) are present. No extra unintended empty default sheet remains.
  3. Validate first sheet name and basic content.
     Expected: `Summary` sheet exists and includes requested header cells.

---

### 16. DOCX-Specific Operations `[AI]`

#### TC-140: Fill document template from CSV data `[AI]`
- Priority: P1
- Preconditions: Consent granted. Workbench has `invoice_template.docx` (with placeholders like {{company}}, {{date}}, {{total}}) and a `client_data.csv` with one row: company, date, item, quantity, price. No Draft.
- Steps:
  1. Type: "Read the invoice template and the client data CSV. Fill in the template placeholders with the data from the CSV. Replace {{company}} with the company name, {{date}} with the date, and {{total}} with quantity * price. Save as the same file." Click Send.
     Expected: The assistant reads both files and modifies the DOCX.
  2. Wait for Draft creation.
     Expected: Draft created. Timeout: 120 seconds.
  3. Verify the draft DOCX.
     Expected: The placeholders are replaced with actual values from the CSV. The company name from the CSV appears in the document. The total value is correct (quantity * price).

---

### 17. PPTX-Specific Operations `[AI]`

#### TC-150: Add slide to existing presentation `[AI]`
- Priority: P1
- Preconditions: Consent granted. Workbench has `slides.pptx`. No Draft.
- Steps:
  1. Type: "Add a new slide at the end of the presentation with the title 'Next Steps' and body text listing 3 action items." Click Send.
     Expected: The assistant uses pptx_operations to add a slide.
  2. Wait for Draft creation.
     Expected: Draft created. Timeout: 120 seconds.
  3. Navigate to review and select the PPTX file.
     Expected: "MODIFIED" badge. Slide preview shows the original plus new slide. The slide counter shows one more slide than the original.
  4. Navigate to the last slide in the preview.
     Expected: The last slide contains "Next Steps" (or similar) as the title.
  5. Verify the draft PPTX.
     Expected: The file has one more slide than the original. The last slide has a title containing "Next Steps".
