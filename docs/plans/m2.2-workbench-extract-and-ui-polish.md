# Implementation Plan: M2.2 - Workbench Extraction + File List/UI Chrome Polish

## Status
Completed (2026-02-05)

## Branch
Use current branch (no new branch).

## Goal
Ship four improvements identified during testing:
1. Extract generated/updated files out of the Workbench.
2. Improve Workbench file row UI to prioritize filename readability.
3. Move Workbench Settings from a permanent top-right text button to a bottom-left gear icon.
4. Keep Checkpoints in the Workbench top bar but switch to a history-style icon button.

Also update impacted PRD/design docs so specs stay aligned with shipped behavior.

## Decisions Locked
1. Export format: local folder copy only (no archive/zip in M2.2).
2. Export source: Published files only.
3. Draft rule: extraction is blocked while a Draft exists.
4. Icon scope: Workbench only (Home settings placement unchanged).

## Scope

### In scope
1. Engine API for extracting files from Published to a destination directory.
2. Workbench UI action for extraction and result summary.
3. Workbench file row redesign (remove size line, improve filename space).
4. Workbench chrome icon changes (top-bar Checkpoints icon, bottom-left Settings gear).
5. Tests and documentation updates for the above.

### Out of scope
1. ZIP/archive export.
2. Exporting Draft files.
3. Home screen chrome redesign.

## Public API / Data Contract Changes
1. New RPC: `WorkbenchFilesExtract(workbench_id, destination_dir, workbench_paths[]?) -> {extract_results[]}`.
2. New engine result type: `ExtractResult` with `path`, `status`, `reason?`.
3. New app model type: `WorkbenchExtractResult`.

## Implementation Plan (By Area)

### Engine (Go)
1. Added `Manager.FilesExtract` in `engine/internal/workbench/manager.go`.
2. Extraction behavior:
   - validates destination directory,
   - blocks when Draft exists,
   - exports from `published/`,
   - skips existing destination files,
   - returns per-file statuses and reasons.
3. Added RPC handler `WorkbenchFilesExtract` in `engine/internal/engine/engine.go` with structured error mapping.
4. Registered RPC in `engine/cmd/keenbench-engine/main.go`.

### UI / State (Flutter)
1. Added `WorkbenchState.extractFiles(...)` in `app/lib/state/workbench_state.dart`.
2. Added `WorkbenchExtractResult` model in `app/lib/models/models.dart`.
3. Added per-file extraction action button in each Workbench file row.
4. Added extraction flow using directory picker + snackbar result summary.
5. Moved Settings action to bottom-left gear icon in Workbench file panel.
6. Replaced top-bar Checkpoints text button with history icon button.
7. Redesigned file rows in Workbench:
   - removed file size line,
   - kept type/status badges,
   - prioritized filename readability.
8. Added key: `AppKeys.workbenchFileExtractButton(String name)`.

## Test Plan

### Engine
- `cd engine && go test ./...`
- Added/updated tests:
  - `TestFilesExtractAll`
  - `TestFilesExtractBlockedByDraft`
  - `TestFilesExtractSkipsExistingDestination`
  - `TestWorkbenchFilesExtractRPC`

### Flutter
- `cd app && flutter test`
- Existing widget/integration tests validated updated Workbench behavior and keys.

## Documentation Updates
Updated the following docs to reflect implemented behavior:
1. `docs/prd/capabilities/workbench.md`
2. `docs/prd/capabilities/workshop.md`
3. `docs/prd/capabilities/draft-publish.md`
4. `docs/prd/keenbench-prd.md`
5. `docs/design/capabilities/workbench.md`
6. `docs/design/capabilities/workshop.md`
7. `docs/design/capabilities/draft-publish.md`
8. `docs/design/style-guide.md`

## Risks and Mitigations
1. Risk: users expect archive export.
   - Mitigation: docs and UX clearly scope M2.2 to folder-copy extraction.
2. Risk: ambiguity when Draft exists.
   - Mitigation: extraction is explicitly disabled/blocked while Draft exists.
3. Risk: icon-only actions reduce discoverability.
   - Mitigation: tooltips and stable placement.

## Final Implementation-vs-Plan Audit
1. Extract from Workbench: shipped (Published copy-out via `WorkbenchFilesExtract`).
2. File list thumbnails/size concern: shipped via filename-first row redesign and removal of size text in Workbench rows.
3. Settings placement: shipped as bottom-left gear icon in Workbench.
4. Checkpoint button style: shipped as top-bar history icon.
5. Impacted PRD/design docs: shipped and updated in same change set.
6. Scope deviations: none.
