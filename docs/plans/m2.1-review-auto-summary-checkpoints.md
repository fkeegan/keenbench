# Implementation Plan: M2.1 - Review Auto-Open, Review Summary Fallback, Chat Checkpoint Restore

## Status
Completed (2026-02-05)

## Branch
Use current branch (no new branch).

## Goal
Implement three UX improvements discovered during testing:
1. Open Review automatically when a Draft is created (no need to click a Review button first).
2. Populate Review summary content using the model's returned assistant message when per-file summaries are missing.
3. Show publish checkpoints inline in Workshop chat with a Restore action on each publish checkpoint entry.

Also update impacted PRD and design docs so product behavior and implementation stay aligned.

## Current Behavior (Observed)
- `app/lib/screens/workbench_screen.dart` still requires tapping `AppKeys.workbenchReviewButton` to open `ReviewScreen`.
- `app/lib/screens/review_screen.dart` reads per-file `change.summary`; in agentic flow these are often empty because summaries are not always persisted for tool-driven edits.
- Checkpoints are only visible in `app/lib/screens/checkpoints_screen.dart`; chat timeline does not show publish checkpoints or restore controls.

## Scope

### In scope
1. Auto-open Review UX for Draft creation and Draft reopen flows.
2. Engine + UI fallback summary path from assistant response to Review UI.
3. Inline publish checkpoint cards in chat with restore button behavior.
4. Backward-compatible API/data changes needed to support the above.
5. Test updates (engine + Flutter integration tests + E2E selectors/flows).
6. PRD and design document updates.

### Out of scope
1. Replacing the standalone Checkpoints screen.
2. Reworking checkpoint retention/restore algorithms.
3. Unrelated workflow changes beyond documentation alignment if references are touched.

## Acceptance Criteria
1. After a message creates a Draft, the user is navigated to `ReviewScreen` automatically.
2. Reopening a Workbench with an existing Draft also opens Review automatically.
3. Review summary panel is no longer empty when the assistant returned usable summary text.
4. Publish checkpoints appear inline in Workshop chat timeline.
5. Each publish checkpoint chat entry has a Restore control that runs `CheckpointRestore` and refreshes Workbench state.
6. Restore actions are blocked while a Draft exists, with clear UI guidance.
7. Existing Draft/Publish safety invariants remain unchanged.
8. All impacted docs are updated in the same change set.

## Technical Plan

### Phase 1: Auto-open Review
1. Update `app/lib/screens/workbench_screen.dart`:
- Add Draft transition detection (no Draft -> Draft, and load with existing Draft).
- Trigger navigation to `ReviewScreen` via post-frame callback.
- Remove dependency on explicit `Review` button as the primary entry path.

2. Keep Draft safety UX explicit:
- Preserve Draft banner and Discard action.
- Ensure there is no dead-end if user exits Review while Draft exists (decide and implement one consistent fallback behavior).

3. Update keys/tests:
- Remove or repurpose `AppKeys.workbenchReviewButton` usage in tests.
- Update integration tests that currently tap Review manually.

### Phase 2: Review Summary Fallback
1. Engine persistence path:
- In `engine/internal/engine/engine.go` (`WorkshopRunAgent`), when a run produces/updates Draft, persist a Draft-level summary from final assistant text under review metadata for that `draft_id`.
- Keep existing per-file summary writing intact.

2. Review API enrichment:
- Extend `ReviewGetChangeSet` response with a top-level `draft_summary` (backward-compatible additional field).
- For each change item, keep per-file `summary` as primary source.

3. UI rendering behavior in `app/lib/screens/review_screen.dart`:
- Summary precedence:
  1. `change.summary` (per-file summary)
  2. `draft_summary` (assistant message fallback)
  3. `Summary unavailable.`
- Render fallback safely as markdown-compatible text (no link navigation, same as chat behavior constraints).

### Phase 3: Checkpoints Inline in Chat
1. Engine conversation events:
- Extend conversation entry shape in `engine/internal/engine/engine.go` to support event metadata.
- On `DraftPublish`, append a conversation system event with publish checkpoint metadata (`checkpoint_id`, `reason=publish`, timestamp).
- On `CheckpointRestore`, append a restore system event (after restore completes).

2. Engine notifications:
- Ensure publish path emits checkpoint notification consistently (if missing in `DraftPublish` today).
- Keep existing `CheckpointCreated` and `CheckpointRestored` notifications compatible.

3. Flutter data model:
- Extend `ChatMessage` in `app/lib/models/models.dart` to parse `type`, `created_at`, and optional metadata/event kind.
- Introduce a chat timeline item model or mapper to render mixed entries (user/assistant + checkpoint system cards).

4. Chat UI in `app/lib/screens/workbench_screen.dart`:
- Render publish checkpoint entries inline in the message list.
- Each publish entry shows concise checkpoint info and a `Restore` button.
- `Restore` action calls `CheckpointRestore`, then reloads Workbench files/messages/draft/clutter state.
- Disable restore while Draft exists with tooltip guidance.

5. Keep full checkpoint management intact:
- `CheckpointsScreen` remains for manual checkpoint creation and full history.
- Chat inline cards focus on publish checkpoints as requested.

## API and Data Contract Changes (Backward Compatible)
1. `ReviewGetChangeSet` response adds optional `draft_summary`.
2. `WorkshopGetConversation` messages may include optional event metadata fields.
3. Conversation JSONL entries may include `type=system_event` with checkpoint payload details.

## Test Plan

### Engine tests (`engine/internal/engine/*_test.go`)
1. `WorkshopRunAgent` writes Draft-level summary fallback when Draft exists.
2. `ReviewGetChangeSet` returns `draft_summary` and preserves per-file summaries.
3. `DraftPublish` appends publish checkpoint conversation event.
4. `CheckpointRestore` appends restore conversation event.
5. Backward compatibility: old conversation entries (without metadata) still parse.

### Flutter tests
1. Workbench auto-navigates to Review when Draft appears.
2. Review summary panel uses fallback assistant/draft summary when per-file summary missing.
3. Chat renders publish checkpoint card with restore button.
4. Restore from chat refreshes UI state and handles blocked-while-draft case.

### Integration / E2E
1. Update existing E2E tests that currently tap `workbenchReviewButton`:
- `app/integration_test/e2e_m0_workshop_flow_test.dart`
- `app/integration_test/e2e_m1_file_ops_test.dart`
2. Add E2E assertion that publish produces a checkpoint card in chat and restore is actionable.

## Documentation Update Plan
Update docs in the same PR to reflect final behavior.

### PRD updates
1. `docs/prd/capabilities/workshop.md`
- Replace "Review Draft button action" language with auto-open Review behavior.
- Document checkpoint cards in chat timeline (publish entries + restore action).

2. `docs/prd/capabilities/review-diff.md`
- Clarify summary fallback order (per-file summary, then assistant/draft summary fallback).

3. `docs/prd/capabilities/draft-publish.md`
- Align Draft-state UX wording with auto-open Review.
- Note publish checkpoint surfaced inline in chat.

4. `docs/prd/keenbench-prd.md`
- Update FR4/FR5 wording where it currently assumes explicit Review button flow.
- Mention publish checkpoints visible in chat timeline with restore affordance.

### Design updates
1. `docs/design/capabilities/workshop.md`
- Update layout/actions and Draft-state flow to auto-open Review.
- Add chat system-event treatment for publish checkpoint entries.

2. `docs/design/capabilities/review-diff.md`
- Update summary source contract to include draft-level assistant summary fallback.

3. `docs/design/capabilities/draft-publish.md`
- Update Draft indicator/actions section for auto-open Review behavior.
- Ensure publish event emission and checkpoint chat surfacing are documented.

4. `docs/design/capabilities/checkpoints.md`
- Add inline chat checkpoint entry behavior for publish checkpoints.
- Keep Checkpoints screen responsibilities for full history/manual actions.

## Execution Order
1. Engine data/API changes (summary fallback + checkpoint conversation events).
2. Flutter model/state changes.
3. Workbench and Review UI changes.
4. Test updates and execution.
5. PRD/design document updates.
6. Final implementation-vs-plan audit note in this plan file.

## Risks and Mitigations
1. Risk: Auto-navigation loops if Review is dismissed without resolving Draft.
- Mitigation: implement one clear fallback policy and test back-navigation explicitly.

2. Risk: Long assistant messages reduce summary readability.
- Mitigation: apply truncation/display clamp in UI while preserving full text availability.

3. Risk: Restore from chat can feel destructive/confusing.
- Mitigation: preserve explicit restore confirmation and draft-block guardrails.

4. Risk: Event schema changes break old conversation parsing.
- Mitigation: keep all new fields optional and maintain tolerant parsing.

## Definition of Done
1. All acceptance criteria pass.
2. `cd engine && go test ./...` passes.
3. `cd app && flutter test` passes.
4. Updated E2E flows pass for affected scenarios.
5. All listed PRD/design docs are updated and consistent with shipped behavior.

## Final Implementation-vs-Plan Audit (2026-02-05)
- Overall: Completed for in-scope M2.1 behavior.
- Auto-open Review: shipped for both Draft creation transitions and Workbench reopen with existing Draft.
- Review summary fallback: shipped with precedence `change.summary` → `draft_summary` → `Summary unavailable.`.
- Chat publish checkpoints: shipped as inline Workshop timeline cards with Restore affordance.
- Restore blocking: shipped; restore actions are disabled while a Draft exists, with explicit guidance.
- Checkpoints boundaries: shipped; standalone Checkpoints screen remains the full history/manual checkpoint management surface.
- Scope deviations: none.
